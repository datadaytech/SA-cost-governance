#
# Macros for Diagnostic Searches
#

#
# Time range for diagnostic lookback (default 7 days)
#
[diag_lookback_days]
definition = 7
iseval = 0

[diag_earliest]
definition = -7d@d
iseval = 0

[diag_latest]
definition = now
iseval = 0

#
# Get the current run_id from the meta collection
#
[get_current_run_id]
definition = inputlookup diagnostic_meta_lookup | where status="running" | head 1 | fields run_id | return $run_id
iseval = 0

#
# Generate a new unique run ID
#
[generate_run_id]
definition = sha1(host."-".now()."-".random())
iseval = 1

#
# Standard output fields for all diagnostic searches
#
[diag_output_fields]
definition = table run_id, run_time, category, metric_name, metric_value, details, search_name
iseval = 0

#
# Append results to the KV store
#
[diag_output_to_kvstore]
definition = outputlookup append=t diagnostic_results_lookup
iseval = 0

#
# Format JSON details safely
#
[json_details(1)]
args = json_string
definition = if(isnull($json_string$), "{}", $json_string$)
iseval = 1

#
# Calculate percentage
#
[calc_pct(2)]
args = numerator, denominator
definition = if($denominator$>0, round(($numerator$/$denominator$)*100, 2), 0)
iseval = 1

#
# Environment detection - determines if running on Cloud or Enterprise
# Returns: "cloud" if _cmc_summary exists, "enterprise" otherwise
#
[detect_environment]
definition = eventcount summarize=false index=_cmc_summary | eval environment=if(count>0, "cloud", "enterprise") | fields environment
iseval = 0

#
# Check if introspection index is available (Enterprise with resource monitoring)
#
[has_introspection]
definition = eventcount summarize=false index=_introspection | eval has_introspection=if(count>0, "true", "false") | fields has_introspection
iseval = 0
