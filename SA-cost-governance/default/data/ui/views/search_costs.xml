<dashboard version="1.1" theme="dark">
  <label>Search Costs</label>
  <description>Analysis of search resource consumption and cost estimation</description>

  <row>
    <panel>
      <title>Currently Running Searches</title>
      <table>
        <search>
          <query>| rest /services/search/jobs splunk_server=local
| where dispatchState="RUNNING"
| eval duration=now()-dispatchTime
| eval scanCount_M=round(scanCount/1000000, 2)
| sort -duration
| table label, user, duration, scanCount_M, eventCount, dispatchState
| rename label as "Search", user as "User", duration as "Running (s)", scanCount_M as "Scans (M)", eventCount as "Events", dispatchState as "State"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Scheduled Search Performance (Last 24h)</title>
      <table>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=local
| search is_scheduled=1 disabled=0
| table title, author, cron_schedule, dispatch.earliest_time, dispatch.latest_time, qualifiedSearch
| rename title as "Search Name", author as "Owner", cron_schedule as "Schedule", dispatch.earliest_time as "Earliest", dispatch.latest_time as "Latest"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Search Cost Estimation by User</title>
      <chart>
        <search>
          <query>index=_audit action=search info=granted
| stats count as search_count, avg(total_run_time) as avg_runtime by user
| eval cost_score=round(search_count * avg_runtime / 60, 2)
| sort -cost_score
| head 10
| table user, search_count, avg_runtime, cost_score</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Cost Score</option>
        <option name="charting.axisTitleY.text">User</option>
        <option name="charting.legend.placement">none</option>
      </chart>
    </panel>
    <panel>
      <title>Heavy Searches (High Scan Count)</title>
      <table>
        <search>
          <query>| rest /services/search/jobs splunk_server=local
| where scanCount > 1000000
| eval scanCount_M=round(scanCount/1000000, 2)
| sort -scanCount
| head 20
| table label, user, runDuration, scanCount_M
| rename label as "Search", user as "User", runDuration as "Duration (s)", scanCount_M as "Scans (M)"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Long Running Searches (>5 min)</title>
      <table>
        <search>
          <query>| rest /services/search/jobs splunk_server=local
| where runDuration > 300
| eval runDuration_min=round(runDuration/60, 1)
| sort -runDuration
| head 20
| table label, user, runDuration_min, scanCount, eventCount
| rename label as "Search", user as "User", runDuration_min as "Duration (min)", scanCount as "Scans", eventCount as "Events"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
</dashboard>
