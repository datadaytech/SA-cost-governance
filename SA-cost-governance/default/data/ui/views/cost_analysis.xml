<dashboard version="1.1" theme="dark" script="governance.js" stylesheet="governance.css">
  <label>Cost Analysis</label>
  <description>Quantify SVC resource usage and cost savings from governance enforcement</description>

  <!-- Base search that loads cached cost analysis results via loadjob -->
  <search id="cost_cache_base">
    <query>| inputlookup governance_cache_sid_lookup
| head 1
| map search="| loadjob $$cache_sid$$" maxsearches=1</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <refresh>5m</refresh>
  </search>

  <!-- Cache Status Row -->
  <row>
    <panel>
      <html>
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: rgba(0,0,0,0.2); border-radius: 6px;">
          <span style="color: rgba(255,255,255,0.6); font-size: 12px;">COST ANALYSIS CACHE</span>
          <span id="cacheStatus" style="color: #00d4ff; font-weight: 600; font-size: 13px;">Loading from cache...</span>
        </div>
      </html>
      <search>
        <query>| inputlookup governance_cache_sid_lookup | head 1 | eval cache_display = "Cached: ".strftime(cache_time, "%Y-%m-%d %H:%M:%S")." (".result_count." searches)" | table cache_display</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
        <done>
          <set token="cache_status">$result.cache_display$</set>
        </done>
      </search>
    </panel>
  </row>

  <!-- SVC Usage Summary Row -->
  <row>
    <panel>
      <single>
        <title>Total Monthly SVC Usage</title>
        <search base="cost_cache_base">
          <query>| search disabled=0 | stats sum(monthly_svc_usage) as total_svc_usage</query>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[5000,15000]</option>
        <option name="useColors">1</option>
        <option name="unit"> SVCs</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Monthly Cost (Active Searches)</title>
        <search base="cost_cache_base">
          <query>| search disabled=0 | stats sum(monthly_total_cost) as total_monthly_cost</query>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[500000,1500000]</option>
        <option name="useColors">1</option>
        <option name="unit">$</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Estimated Annual Cost</title>
        <search base="cost_cache_base">
          <query>| search disabled=0 | eval annual_cost = monthly_total_cost * 12 | stats sum(annual_cost) as total_annual_cost</query>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[6000000,18000000]</option>
        <option name="useColors">1</option>
        <option name="unit">$</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Annual SVC Cost</title>
        <search>
          <query>| inputlookup governance_settings_lookup
| search setting_name="svc_unit_cost"
| append [| makeresults | eval setting_value="1600"]
| head 1
| eval cost = "$".setting_value."/SVC/year"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="useColors">0</option>
      </single>
    </panel>
  </row>

  <!-- Savings Summary Row -->
  <row>
    <panel>
      <single>
        <title>SVCs Saved (Disabled Searches)</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status="disabled"
| eval mock_svc_saved = 85
| eval runs_per_month_saved = 720
| eval monthly_svc_saved = mock_svc_saved * runs_per_month_saved
| stats sum(monthly_svc_saved) as total_svc_saved</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x708794","0x53a051","0x65a637"]</option>
        <option name="rangeValues">[10000,50000]</option>
        <option name="useColors">1</option>
        <option name="unit"> SVCs</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Monthly Savings (Disabled)</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status="disabled"
| eval mock_svc_saved = 85
| eval runs_per_month_saved = 720
| eval monthly_svc_saved = mock_svc_saved * runs_per_month_saved
| eval svc_annual_cost = 1600
| eval saved_monthly_cost = round(monthly_svc_saved * (svc_annual_cost / 12), 2)
| stats sum(saved_monthly_cost) as total_monthly_savings</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x708794","0x53a051","0x65a637"]</option>
        <option name="rangeValues">[500000,2000000]</option>
        <option name="useColors">1</option>
        <option name="unit">$</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>SVCs Saved (Redistributed)</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status IN ("pending", "notified", "resolved")
| eval mock_svc_reduction = 45
| eval runs_per_month_saved = 400
| eval monthly_svc_saved = mock_svc_reduction * runs_per_month_saved
| stats sum(monthly_svc_saved) as total_svc_saved</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x708794","0x53a051","0x65a637"]</option>
        <option name="rangeValues">[5000,25000]</option>
        <option name="useColors">1</option>
        <option name="unit"> SVCs</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Searches Optimized</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status IN ("disabled", "resolved")
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x708794","0x53a051","0x65a637"]</option>
        <option name="rangeValues">[5,20]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- SVC Usage Charts -->
  <row>
    <panel>
      <title>Monthly SVC Usage by Application</title>
      <chart>
        <search base="cost_cache_base">
          <query>| search disabled=0 | stats sum(monthly_svc_usage) as svc_usage by app | sort - svc_usage | head 15</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleY.text">Monthly SVC Usage</option>
        <option name="height">300</option>
      </chart>
    </panel>
    <panel>
      <title>Monthly SVC Usage by Owner</title>
      <chart>
        <search base="cost_cache_base">
          <query>| search disabled=0 | stats sum(monthly_svc_usage) as svc_usage by owner | sort - svc_usage | head 15</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleY.text">Monthly SVC Usage</option>
        <option name="height">300</option>
      </chart>
    </panel>
  </row>

  <!-- Cost Distribution -->
  <row>
    <panel>
      <title>Cost Tier Distribution</title>
      <chart>
        <search base="cost_cache_base">
          <query>| search disabled=0 | eval cost_tier = case(monthly_total_cost >= 50000, "Critical", monthly_total_cost >= 20000, "High", monthly_total_cost >= 5000, "Medium", monthly_total_cost >= 1000, "Low", 1=1, "Minimal") | stats count by cost_tier | eval sort_order = case(cost_tier="Critical", 1, cost_tier="High", 2, cost_tier="Medium", 3, cost_tier="Low", 4, 1=1, 5) | sort sort_order | fields - sort_order</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">300</option>
      </chart>
    </panel>
    <panel>
      <title>SVC Usage by Frequency</title>
      <chart>
        <search base="cost_cache_base">
          <query>| search disabled=0 | stats sum(monthly_svc_usage) as "SVC Usage" count as "Search Count" by frequency_label | sort - "SVC Usage"</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">300</option>
      </chart>
    </panel>
  </row>

  <!-- High Cost Searches Table -->
  <row>
    <panel>
      <title>Highest Cost Scheduled Searches - Optimization Candidates</title>
      <table id="high_cost_table">
        <search base="cost_cache_base">
          <query>| search disabled=0
| eval svc_per_run_display = tostring(round(svc_per_run, 0))
| eval monthly_svc_display = tostring(round(monthly_svc_usage, 0))
| eval monthly_cost_display = "$".tostring(round(monthly_total_cost, 2))
| eval annual_cost = monthly_total_cost * 12
| eval annual_cost_display = "$".tostring(round(annual_cost, 2))
| table title, owner, app, cron_schedule, frequency_label, runs_per_month, svc_per_run_display, monthly_svc_display, monthly_cost_display, annual_cost_display, cost_tier
| rename title as "Search Name", owner as "Owner", app as "App", cron_schedule as "Schedule", frequency_label as "Frequency", runs_per_month as "Runs/Month", svc_per_run_display as "SVC/Run", monthly_svc_display as "Monthly SVCs", monthly_cost_display as "Monthly Cost", annual_cost_display as "Annual Cost", cost_tier as "Cost Tier"
| sort - "Monthly Cost"
| head 25</query>
        </search>
        <option name="count">15</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="Cost Tier">
          <colorPalette type="map">{"Critical":#DC4E41,"High":#F1813F,"Medium":#F8BE34,"Low":#53A051,"Minimal":#708794}</colorPalette>
        </format>
        <format type="color" field="Monthly Cost">
          <colorPalette type="minMidMax" maxColor="#DC4E41" midColor="#F8BE34" minColor="#53A051"></colorPalette>
          <scale type="minMidMax" midValue="100"></scale>
        </format>
        <format type="color" field="SVC/Run">
          <colorPalette type="minMidMax" maxColor="#DC4E41" midColor="#F8BE34" minColor="#53A051"></colorPalette>
          <scale type="minMidMax" midValue="50"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Savings Detail -->
  <row>
    <panel>
      <title>Governance Actions - Cost Impact</title>
      <table>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status IN ("disabled", "resolved")
| eval action_date = strftime(flagged_time, "%Y-%m-%d")
| eval mock_svc_saved = case(status="disabled", 85, 1=1, 45)
| eval runs_per_month_saved = case(status="disabled", 720, 1=1, 400)
| eval monthly_svc_saved = mock_svc_saved * runs_per_month_saved
| eval monthly_saved = round(monthly_svc_saved * 0.10, 2)
| eval monthly_saved_display = "$".tostring(round(monthly_saved, 2))
| eval annual_saved_display = "$".tostring(round(monthly_saved * 12, 2))
| eval svc_saved_display = tostring(monthly_svc_saved)." SVCs"
| eval action_type = case(status="disabled", "Disabled", status="resolved", "Redistributed", 1=1, status)
| table search_name, search_owner, search_app, action_date, action_type, svc_saved_display, monthly_saved_display, annual_saved_display, reason
| rename search_name as "Search Name", search_owner as "Owner", search_app as "App", action_date as "Action Date", action_type as "Action", svc_saved_display as "SVCs Saved", monthly_saved_display as "Monthly Savings", annual_saved_display as "Annual Savings", reason as "Reason"
| sort - "Monthly Savings"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="Action">
          <colorPalette type="map">{"Disabled":#DC4E41,"Redistributed":#53A051}</colorPalette>
        </format>
        <format type="color" field="Monthly Savings">
          <colorPalette type="minMidMax" maxColor="#65A637" midColor="#53A051" minColor="#708794"></colorPalette>
          <scale type="minMidMax" midValue="500"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ROI Summary -->
  <row>
    <panel>
      <title>Governance ROI Summary</title>
      <html>
        <div style="background: linear-gradient(135deg, rgba(83, 160, 81, 0.15) 0%, rgba(101, 166, 55, 0.15) 100%); border: 1px solid rgba(83, 160, 81, 0.3); border-radius: 12px; padding: 24px; text-align: center;">
          <h3 style="color: #53a051; margin-bottom: 16px; font-size: 18px;">SVC-Based Cost Optimization Through Governance</h3>
          <p style="color: rgba(255,255,255,0.8); font-size: 14px; line-height: 1.6;">
            This dashboard tracks the financial impact of governance actions on scheduled searches using SVC (Splunk Virtual Compute) metrics.
            By identifying and optimizing wasteful or problematic searches, organizations can significantly
            reduce their Splunk operational costs while maintaining data quality and system performance.
          </p>
          <div style="margin-top: 20px; display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
            <div style="text-align: center; min-width: 150px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">Cost Model</div>
              <div style="font-size: 14px; color: white; margin-top: 4px;">$1,600/SVC annually ($133.33/mo)</div>
            </div>
            <div style="text-align: center; min-width: 150px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">Regular Search</div>
              <div style="font-size: 14px; color: white; margin-top: 4px;">15-30 SVCs/run (~$2-4K/mo)</div>
            </div>
            <div style="text-align: center; min-width: 150px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">Expensive Search</div>
              <div style="font-size: 14px; color: white; margin-top: 4px;">80-120 SVCs/run (~$10-16K/mo)</div>
            </div>
            <div style="text-align: center; min-width: 150px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px;">Optimization Target</div>
              <div style="font-size: 14px; color: white; margin-top: 4px;">High-frequency &amp; high-SVC searches</div>
            </div>
          </div>
        </div>
      </html>
    </panel>
  </row>

</dashboard>
