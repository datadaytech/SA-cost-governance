<dashboard version="1.1" theme="dark" script="governance.js" stylesheet="governance.css">
  <label>Cost Governance Dashboard</label>
  <description>Monitor, flag, and enforce policies on scheduled searches</description>

  <!-- Initialization -->
  <init>
    <set token="show_flagged_only">false</set>
    <set token="view_mode">all</set>
  </init>

  <!-- Last Action Timestamp -->
  <row>
    <panel>
      <html>
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: rgba(0,0,0,0.2); border-radius: 6px;">
          <span style="color: rgba(255,255,255,0.6); font-size: 12px;">LAST GOVERNANCE ACTION</span>
          <span id="lastActionTimestamp" style="color: #00d4ff; font-weight: 600; font-size: 13px;">Loading...</span>
          <span style="color: rgba(255,255,255,0.4); font-size: 11px;">Data cached every 5 min</span>
        </div>
      </html>
      <search>
        <query>| inputlookup governance_audit_log_lookup | sort - timestamp | head 1 | eval display = strftime(timestamp, "%Y-%m-%d %H:%M:%S") . " - " . action . " by " . performed_by | table display</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
        <refresh>30s</refresh>
        <done>
          <set token="last_action_display">$result.display$</set>
        </done>
      </search>
    </panel>
  </row>

  <!-- Summary Metrics Row - Using cached data -->
  <row>
    <panel id="total_metric_panel">
      <single id="total_metric">
        <title>Total Scheduled Searches</title>
        <search>
          <query>| inputlookup governance_search_cache.csv
| search disabled=0
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="useColors">0</option>
      </single>
    </panel>
    <panel id="suspicious_metric_panel">
      <single id="suspicious_metric">
        <title>Suspicious (Unflagged)</title>
        <search>
          <query>| inputlookup governance_search_cache.csv
| search is_suspicious=1 disabled=0
| lookup flagged_searches_lookup search_name as title OUTPUT status as flag_status
| where isnull(flag_status) OR flag_status=""
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[5,10]</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="metric_popup_type">suspicious</set>
          <set token="metric_popup_value">$click.value$</set>
          <set token="metric_popup_title">Suspicious Searches</set>
        </drilldown>
      </single>
    </panel>
    <panel id="flagged_metric_panel">
      <single id="flagged_metric">
        <title>Flagged</title>
        <search>
          <query>| inputlookup flagged_searches_lookup | search status="pending" OR status="notified" | stats dc(search_name) as count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[3,7]</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="metric_popup_type">flagged</set>
          <set token="metric_popup_value">$click.value$</set>
          <set token="metric_popup_title">Flagged Searches</set>
        </drilldown>
      </single>
    </panel>
    <panel id="pending_review_metric_panel">
      <single id="pending_review_metric">
        <title>Pending Review</title>
        <search>
          <query>| inputlookup flagged_searches_lookup | search status="review" | stats dc(search_name) as count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x6f42c1","0xdc4e41"]</option>
        <option name="rangeValues">[3,7]</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="metric_popup_type">pending_review</set>
          <set token="metric_popup_value">$click.value$</set>
          <set token="metric_popup_title">Pending Review</set>
        </drilldown>
      </single>
    </panel>
    <panel id="expiring_metric_panel">
      <single id="expiring_metric">
        <title>Expiring Soon (≤3 Days)</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status="pending" OR status="notified"
| dedup search_name
| eval days_remaining = round((remediation_deadline - now()) / 86400, 1)
| where days_remaining >= 0 AND days_remaining &lt;= 3
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[1,3]</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="metric_popup_type">expiring</set>
          <set token="metric_popup_value">$click.value$</set>
          <set token="metric_popup_title">Expiring Soon</set>
        </drilldown>
      </single>
    </panel>
    <panel id="disabled_metric_panel">
      <single id="disabled_metric">
        <title>Auto-Disabled (This Period)</title>
        <search>
          <query>| inputlookup flagged_searches_lookup
| search status="disabled"
| dedup search_name
| eval days_ago = (now() - flagged_time) / 86400
| where days_ago &lt;= 7
| stats count as disabled_count
| eval disabled_count = if(isnull(disabled_count), 0, disabled_count)
| table disabled_count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x006d9c"]</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="metric_popup_type">disabled</set>
          <set token="metric_popup_value">$click.value$</set>
          <set token="metric_popup_title">Auto-Disabled Searches</set>
        </drilldown>
      </single>
    </panel>
  </row>

  <!-- All Scheduled Searches Panel -->
  <row>
    <panel>
      <title>All Scheduled Searches</title>
      <input type="dropdown" token="view_filter" searchWhenChanged="true">
        <label>View</label>
        <choice value="all">All Searches</choice>
        <choice value="suspicious">Suspicious Only</choice>
        <choice value="flagged">Flagged Only</choice>
        <choice value="pending_review">Pending Review</choice>
        <choice value="expiring">Expiring Soon (≤3 Days)</choice>
        <default>all</default>
      </input>
      <input type="dropdown" token="filter_status" searchWhenChanged="true">
        <label>Status</label>
        <choice value="*">All</choice>
        <choice value="0">Enabled Only</choice>
        <choice value="1">Disabled Only</choice>
        <default>0</default>
      </input>
      <input type="dropdown" token="filter_app" searchWhenChanged="true">
        <label>App</label>
        <choice value="*">All Apps</choice>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches splunk_server=local | search is_scheduled=1 | rename eai:acl.app as app | stats count by app | sort - count | eval app_label = app . " (" . count . ")" | fields app, app_label</query>
        </search>
        <fieldForLabel>app_label</fieldForLabel>
        <fieldForValue>app</fieldForValue>
        <default>*</default>
      </input>
      <input type="text" token="filter_owner" searchWhenChanged="true">
        <label>Owner</label>
        <default>*</default>
      </input>
      <table id="all_searches_table">
        <search>
          <query>| inputlookup governance_search_cache.csv
| search app=$filter_app$ owner=$filter_owner$
| lookup flagged_searches_lookup search_name as title OUTPUT status as flag_status, remediation_deadline, flagged_by, flagged_time, reason as flag_reason
| eval governance_status = case(
    disabled=1, "Disabled",
    flag_status="disabled", "Disabled by Governance",
    flag_status="notified", "Notified",
    flag_status="pending", "Flagged",
    flag_status="review", "Pending Review",
    flag_status="resolved", "OK",
    is_suspicious=1 AND (isnull(flag_status) OR flag_status=""), "Suspicious",
    1=1, "OK")
| eval is_flagged_search = if(flag_status="pending" OR flag_status="notified" OR flag_status="disabled", 1, 0)
| eval seconds_remaining = if(flag_status="notified" AND isnotnull(remediation_deadline), remediation_deadline - now(), null())
| eval days_num = floor(seconds_remaining / 86400)
| eval hours_num = floor((seconds_remaining - (days_num * 86400)) / 3600)
| eval mins_num = floor((seconds_remaining - (days_num * 86400) - (hours_num * 3600)) / 60)
| eval days_remaining = case(
    flag_status="notified" AND isnotnull(seconds_remaining) AND seconds_remaining &gt; 0,
        days_num . "d " . hours_num . "h " . mins_num . "m",
    flag_status="notified" AND isnotnull(seconds_remaining) AND seconds_remaining &lt;= 0, "EXPIRED",
    flag_status="pending", "Awaiting",
    flag_status="disabled" OR flag_status="resolved", "N/A",
    1=1, null())
| eval is_expiring_soon = if(isnotnull(seconds_remaining) AND seconds_remaining &gt;= 0 AND seconds_remaining &lt;= 259200, 1, 0)
| eval is_suspicious_unflagged = if(is_suspicious=1 AND disabled=0 AND (isnull(flag_status) OR flag_status=""), 1, 0)
| eval is_pending_review = if(flag_status="review", 1, 0)
| eval view_match = case(
    "$view_filter$"="suspicious", is_suspicious_unflagged,
    "$view_filter$"="flagged", is_flagged_search,
    "$view_filter$"="pending_review", is_pending_review,
    "$view_filter$"="expiring", is_expiring_soon,
    1=1, 1)
| where view_match=1
| eval is_disabled = if(disabled=1 OR disabled="1" OR flag_status="disabled", 1, 0)
| eval status_filter_match = case(
    "$filter_status$"="*", 1,
    "$filter_status$"="0" AND is_disabled=0, 1,
    "$filter_status$"="1" AND is_disabled=1, 1,
    1=1, 0)
| where status_filter_match=1
| eval flagged_date = if(isnotnull(flagged_time), strftime(flagged_time, "%Y-%m-%d"), "")
| eval deadline_date = if(isnotnull(remediation_deadline), strftime(remediation_deadline, "%Y-%m-%d"), "")
| eval sort_priority = case(
    governance_status="Suspicious", 1,
    governance_status="Pending Review", 2,
    governance_status="Flagged", 3,
    governance_status="Notified", 4,
    governance_status="OK", 5,
    governance_status="Disabled", 6,
    governance_status="Disabled by Governance", 7,
    1=1, 8)
| sort sort_priority, - runtime_ratio
| eval display_name = title
| eval display_reason = coalesce(flag_reason, suspicious_reason, "")
| table display_name, governance_status, owner, app, cron_schedule, frequency_label, avg_runtime_display, run_count, runtime_ratio, days_remaining, flagged_by, display_reason
| rename display_name as "Search Name", governance_status as "Status", owner as "Owner", app as "App", cron_schedule as "Schedule", frequency_label as "Frequency", avg_runtime_display as "Avg Runtime", run_count as "Runs", runtime_ratio as "Runtime %", days_remaining as "Days Left", flagged_by as "Flagged By", display_reason as "Reason"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <refresh>1m</refresh>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"OK":#53A051,"Suspicious":#F8BE34,"Flagged":#F1813F,"Notified":#DC4E41,"Pending Review":#6F42C1,"Disabled by Governance":#708794,"Disabled":#708794,"Enabled":#2EA043}</colorPalette>
        </format>
        <format type="color" field="Runtime %">
          <colorPalette type="minMidMax" maxColor="#DC4E41" midColor="#F8BE34" minColor="#53A051"></colorPalette>
          <scale type="minMidMax" midValue="10"></scale>
        </format>
        <format type="color" field="Days Left">
          <colorPalette type="minMidMax" maxColor="#53A051" midColor="#F8BE34" minColor="#DC4E41"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="3" maxValue="7"></scale>
        </format>
      </table>
    </panel>
  </row>

</dashboard>
