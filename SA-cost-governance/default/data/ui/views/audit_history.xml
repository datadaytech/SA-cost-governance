<dashboard version="1.1" theme="dark" script="governance.js" stylesheet="governance.css">
  <label>Audit History</label>
  <description>Complete audit trail of all governance actions across scheduled searches and dashboards</description>

  <!-- Main Audit Log with Inline Filters (TOP) -->
  <row>
    <panel>
      <title>Audit History Log</title>
      <input type="dropdown" token="filter_type" searchWhenChanged="true">
        <label>Asset Type</label>
        <choice value="">All</choice>
        <choice value="scheduled_search">Scheduled Searches</choice>
        <choice value="dashboard">Dashboards</choice>
        <default></default>
      </input>
      <input type="dropdown" token="filter_action" searchWhenChanged="true">
        <label>Action</label>
        <choice value="*">All Actions</choice>
        <choice value="flagged">Flagged</choice>
        <choice value="unflagged">Unflagged / Resolved</choice>
        <choice value="disabled">Disabled</choice>
        <choice value="notification_sent">Notification Sent</choice>
        <choice value="extended">Deadline Extended</choice>
        <choice value="schedule_changed">Schedule Changed</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="filter_user" searchWhenChanged="true">
        <label>Performed By</label>
        <choice value="*">All Users</choice>
        <search>
          <query>| inputlookup governance_audit_log_lookup | stats count by performed_by | fields performed_by</query>
        </search>
        <fieldForLabel>performed_by</fieldForLabel>
        <fieldForValue>performed_by</fieldForValue>
        <default>*</default>
      </input>
      <input type="time" token="time_filter" searchWhenChanged="true">
        <label>Time Range</label>
        <default>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
        </default>
      </input>
      <table id="audit_log_table">
        <search>
          <query>| inputlookup governance_audit_log_lookup
| eval asset_type_key = case(
    match(action, "dashboard"), "dashboard",
    1=1, "scheduled_search")
| eval asset_type = case(
    asset_type_key="dashboard", "Dashboard",
    1=1, "Scheduled Search")
| where (asset_type_key="$filter_type$" OR "$filter_type$"="")
| search action=$filter_action$ performed_by=$filter_user$
| eval time = strftime(timestamp, "%Y-%m-%d %H:%M:%S")
| eval action_display = case(
    action="flagged", "Flagged for Review",
    action="flagged_dashboard", "Dashboard Flagged",
    action="unflagged", "Unflagged / Resolved",
    action="disabled", "Disabled",
    action="notification_sent", "Notification Sent",
    action="extended", "Deadline Extended",
    action="schedule_changed", "Schedule Changed",
    action="tracked", "Added to Tracking",
    1=1, action)
| sort - timestamp
| table time, action_display, search_name, asset_type, performed_by, details
| rename time as "Timestamp", action_display as "Action", search_name as "Item Name", asset_type as "Type", performed_by as "Performed By", details as "Details"</query>
          <earliest>$time_filter.earliest$</earliest>
          <latest>$time_filter.latest$</latest>
          <refresh>1m</refresh>
        </search>
        <option name="count">25</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="Action">
          <colorPalette type="map">{"Flagged for Review":#F8BE34,"Dashboard Flagged":#F8BE34,"Notification Sent":#006D9C,"Disabled":#DC4E41,"Unflagged / Resolved":#53A051,"Deadline Extended":#65A637,"Schedule Changed":#00D4FF,"Added to Tracking":#9E72C5}</colorPalette>
        </format>
        <format type="color" field="Type">
          <colorPalette type="map">{"Scheduled Search":#006D9C,"Dashboard":#F8BE34}</colorPalette>
        </format>
      </table>
      <html>
        <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
          <button class="btn" onclick="window.print()">Print Report</button>
          <button class="btn btn-primary" onclick="exportAuditLog()">Export to CSV</button>
        </div>
      </html>
    </panel>
  </row>

  <!-- Summary Metrics Row -->
  <row>
    <panel>
      <single>
        <title>Total Actions (30 Days)</title>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| where timestamp > relative_time(now(), "-30d")
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x006d9c"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Searches Flagged</title>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| where timestamp > relative_time(now(), "-30d")
| search action IN ("flagged", "flagged_dashboard")
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xf8be34"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Searches Disabled</title>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| where timestamp > relative_time(now(), "-30d")
| search action="disabled"
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Notifications Sent</title>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| where timestamp > relative_time(now(), "-30d")
| search action="notification_sent"
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x006d9c"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Issues Resolved</title>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| where timestamp > relative_time(now(), "-30d")
| search action IN ("unflagged", "resolved")
| stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0x65a637"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Activity Timeline Chart -->
  <row>
    <panel>
      <title>Governance Activity Over Time</title>
      <chart>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| eval asset_type = case(
    match(action, "dashboard"), "dashboard",
    1=1, "scheduled_search")
| where (asset_type="$filter_type$" OR "$filter_type$"="")
| search action=$filter_action$ performed_by=$filter_user$
| eval date = strftime(timestamp, "%Y-%m-%d")
| stats count by date, action
| sort date</query>
          <earliest>$time_filter.earliest$</earliest>
          <latest>$time_filter.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Actions</option>
        <option name="height">250</option>
      </chart>
    </panel>
    <panel>
      <title>Actions by Type</title>
      <chart>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| eval asset_type = case(
    match(action, "dashboard"), "dashboard",
    1=1, "scheduled_search")
| where (asset_type="$filter_type$" OR "$filter_type$"="")
| search action=$filter_action$ performed_by=$filter_user$
| stats count by action
| sort - count</query>
          <earliest>$time_filter.earliest$</earliest>
          <latest>$time_filter.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
      </chart>
    </panel>
  </row>

  <!-- Activity by User and Items -->
  <row>
    <panel>
      <title>Top Governance Actors</title>
      <chart>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| eval asset_type = case(
    match(action, "dashboard"), "dashboard",
    1=1, "scheduled_search")
| where (asset_type="$filter_type$" OR "$filter_type$"="")
| search action=$filter_action$ performed_by=$filter_user$
| stats count by performed_by
| sort - count
| head 10</query>
          <earliest>$time_filter.earliest$</earliest>
          <latest>$time_filter.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="height">250</option>
      </chart>
    </panel>
    <panel>
      <title>Most Actioned Items</title>
      <chart>
        <search>
          <query>| inputlookup governance_audit_log_lookup
| eval asset_type = case(
    match(action, "dashboard"), "dashboard",
    1=1, "scheduled_search")
| where (asset_type="$filter_type$" OR "$filter_type$"="")
| search action=$filter_action$ performed_by=$filter_user$
| stats count by search_name
| sort - count
| head 10</query>
          <earliest>$time_filter.earliest$</earliest>
          <latest>$time_filter.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="height">250</option>
      </chart>
    </panel>
  </row>

</dashboard>
