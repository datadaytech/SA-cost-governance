# ==========================================
# PII Detection Regex Macros
# ==========================================

# US Social Security Number (SSN)
[pii_ssn_pattern]
definition = \b(?!000|666|9\d{2})[0-9]{3}-?(?!00)[0-9]{2}-?(?!0000)[0-9]{4}\b
iseval = 0

# Credit Card Numbers (Visa, MC, Amex, Discover)
[pii_credit_card_pattern]
definition = \b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b
iseval = 0

# Email Addresses
[pii_email_pattern]
definition = \b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b
iseval = 0

# US Phone Numbers
[pii_phone_us_pattern]
definition = \b(?:\+?1[-.]?)?\(?([0-9]{3})\)?[-.]?([0-9]{3})[-.]?([0-9]{4})\b
iseval = 0

# International Phone Numbers
[pii_phone_intl_pattern]
definition = \b(?:\+\d{1,3}[-.]?)?\d{1,4}[-.]?\d{1,4}[-.]?\d{1,9}\b
iseval = 0

# IP Addresses (IPv4)
[pii_ipv4_pattern]
definition = \b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b
iseval = 0

# IP Addresses (IPv6)
[pii_ipv6_pattern]
definition = \b(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\b
iseval = 0

# US Driver's License (generalized)
[pii_drivers_license_pattern]
definition = \b(?:[A-Z]{1,2}[0-9]{5,8}|[0-9]{7,9})\b
iseval = 0

# US Passport Number
[pii_passport_pattern]
definition = \b[A-Z]{1,2}[0-9]{6,9}\b
iseval = 0

# Bank Account Numbers (8-17 digits)
[pii_bank_account_pattern]
definition = \b[0-9]{8,17}\b
iseval = 0

# Date of Birth (various formats)
[pii_dob_pattern]
definition = \b(?:0?[1-9]|1[0-2])[-/](?:0?[1-9]|[12][0-9]|3[01])[-/](?:19|20)\d{2}\b|\b(?:19|20)\d{2}[-/](?:0?[1-9]|1[0-2])[-/](?:0?[1-9]|[12][0-9]|3[01])\b
iseval = 0

# Medical Record Numbers
[pii_mrn_pattern]
definition = \b(?:MRN|mrn|Medical Record|Patient ID)[:=]?\s*([A-Z0-9]{6,12})\b
iseval = 0

# ==========================================
# PII Detection Search Macros
# ==========================================

# Detect SSN in field
[detect_ssn(1)]
args = field
definition = rex field=$field$ "`pii_ssn_pattern`" | where isnotnull($field$)
iseval = 0

# Detect Credit Cards in field
[detect_credit_card(1)]
args = field
definition = rex field=$field$ "`pii_credit_card_pattern`" | where isnotnull($field$)
iseval = 0

# Detect Email in field
[detect_email(1)]
args = field
definition = rex field=$field$ "`pii_email_pattern`" | where isnotnull($field$)
iseval = 0

# Detect Phone Numbers in field
[detect_phone(1)]
args = field
definition = rex field=$field$ "`pii_phone_us_pattern`" | where isnotnull($field$)
iseval = 0

# Generic PII Scanner - searches _raw for all patterns
[scan_all_pii]
definition = eval has_ssn=if(match(_raw, "`pii_ssn_pattern`"), 1, 0) | eval has_credit_card=if(match(_raw, "`pii_credit_card_pattern`"), 1, 0) | eval has_email=if(match(_raw, "`pii_email_pattern`"), 1, 0) | eval has_phone=if(match(_raw, "`pii_phone_us_pattern`"), 1, 0) | eval has_ip=if(match(_raw, "`pii_ipv4_pattern`"), 1, 0) | eval has_pii=if(has_ssn=1 OR has_credit_card=1 OR has_email=1 OR has_phone=1 OR has_ip=1, 1, 0)
iseval = 0

# Mask SSN (show last 4 digits)
[mask_ssn(1)]
args = field
definition = eval $field$_masked=replace($field$, "(\d{3})-?(\d{2})-?(\d{4})", "XXX-XX-\3")
iseval = 0

# Mask Credit Card (show last 4 digits)
[mask_credit_card(1)]
args = field
definition = eval $field$_masked=replace($field$, "(\d{12,15})(\d{4})", "************\2")
iseval = 0

# Mask Email (show domain only)
[mask_email(1)]
args = field
definition = eval $field$_masked=replace($field$, "([^@]+)@(.+)", "****@\2")
iseval = 0

# Mask Phone (show last 4 digits)
[mask_phone(1)]
args = field
definition = eval $field$_masked=replace($field$, "(\+?\d{0,3}[-.]?)(\d{3})[-.]?(\d{3})[-.]?(\d{4})", "***-***-\4")
iseval = 0

# ==========================================
# Severity Calculation Macros
# ==========================================

# Calculate PII severity based on type
[calculate_pii_severity]
definition = eval severity=case(\
    pii_type="ssn", "critical",\
    pii_type="credit_card", "critical",\
    pii_type="bank_account", "critical",\
    pii_type="passport", "critical",\
    pii_type="drivers_license", "high",\
    pii_type="mrn", "high",\
    pii_type="dob", "high",\
    pii_type="phone", "medium",\
    pii_type="email", "medium",\
    pii_type="ip_address", "low",\
    1=1, "medium")
iseval = 0

# ==========================================
# Whitelisting Macros
# ==========================================

# Check if finding is whitelisted
[check_whitelist(2)]
args = pii_type, value
definition = lookup pii_whitelist_lookup pii_type as $pii_type$ pattern as $value$ OUTPUT whitelist_id | eval is_whitelisted=if(isnotnull(whitelist_id), 1, 0)
iseval = 0

# Get active whitelist entries
[get_active_whitelist]
definition = inputlookup pii_whitelist_lookup | where is_active=1 AND (isnull(expires) OR expires > now())
iseval = 0

# ==========================================
# Index Filtering Macros
# ==========================================

# Default indexes to scan (configurable)
[pii_scan_indexes]
definition = (index=main OR index=web OR index=app OR index=security)
iseval = 0

# Exclude internal Splunk indexes
[exclude_internal_indexes]
definition = NOT (index=_* OR index=splunk* OR index=summary*)
iseval = 0
