<dashboard version="1.1" theme="dark" script="pii_detection.js" stylesheet="pii_detection.css">
  <label>PII Detection Overview</label>
  <description>Comprehensive overview of PII findings across your Splunk environment</description>

  <init>
    <set token="time_range">-24h</set>
    <set token="selected_severity">*</set>
    <set token="selected_status">*</set>
  </init>

  <!-- Time Range Picker -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="selected_severity">
      <label>Severity</label>
      <choice value="*">All</choice>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <choice value="low">Low</choice>
      <default>*</default>
    </input>

    <input type="dropdown" token="selected_status">
      <label>Status</label>
      <choice value="*">All</choice>
      <choice value="detected">Detected</choice>
      <choice value="flagged">Flagged</choice>
      <choice value="remediated">Remediated</choice>
      <choice value="whitelisted">Whitelisted</choice>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Summary Statistics Row -->
  <row>
    <panel>
      <title>Total PII Findings</title>
      <single>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats count as total_findings
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,100,500,1000]</option>
        <option name="underLabel">Total Findings</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>Critical Findings</title>
      <single>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=critical status=$selected_status$
| stats count as critical_findings
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,50]</option>
        <option name="underLabel">Critical Priority</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>Affected Indexes</title>
      <single>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats dc(index) as affected_indexes
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Unique Indexes</option>
      </single>
    </panel>

    <panel>
      <title>Affected Sourcetypes</title>
      <single>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats dc(sourcetype) as affected_sourcetypes
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Unique Sourcetypes</option>
      </single>
    </panel>
  </row>

  <!-- PII Type Distribution -->
  <row>
    <panel>
      <title>PII Findings by Type</title>
      <chart>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats count by pii_type
| sort - count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.showPercent">true</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">right</option>
        <drilldown>
          <set token="selected_pii_type">$click.value$</set>
        </drilldown>
      </chart>
    </panel>

    <panel>
      <title>Severity Distribution</title>
      <chart>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search status=$selected_status$
| stats count by severity
| sort - count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.axisTitleX.text">Severity Level</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="charting.seriesColors">[0xD93F3C,0xF58F39,0xF7BC38,0x65A637]</option>
      </chart>
    </panel>
  </row>

  <!-- Trending Over Time -->
  <row>
    <panel>
      <title>PII Detection Trend (Last 30 Days)</title>
      <chart>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| eval day=strftime(timestamp, "%Y-%m-%d")
| timechart span=1d count by pii_type
| fillnull value=0
          </query>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Findings Count</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>

  <!-- Top Affected Indexes and Sourcetypes -->
  <row>
    <panel>
      <title>Top 10 Affected Indexes</title>
      <table>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats count as findings_count,
    dc(pii_type) as pii_types_count,
    values(pii_type) as pii_types,
    count(eval(severity="critical")) as critical,
    count(eval(severity="high")) as high
    by index
| sort - findings_count
| head 10
| eval pii_types=mvjoin(pii_types, ", ")
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="critical">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="0" midType="number" midValue="5" maxType="number" maxValue="10"></scale>
        </format>
        <format type="color" field="high">
          <colorPalette type="minMidMax" maxColor="#F58F39" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="0" midType="number" midValue="5" maxType="number" maxValue="10"></scale>
        </format>
        <drilldown>
          <set token="selected_index">$row.index$</set>
          <set token="show_details">true</set>
        </drilldown>
      </table>
    </panel>

    <panel>
      <title>Top 10 Affected Sourcetypes</title>
      <table>
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| stats count as findings_count,
    dc(pii_type) as pii_types_count,
    values(pii_type) as pii_types,
    count(eval(severity="critical")) as critical,
    count(eval(severity="high")) as high
    by sourcetype
| sort - findings_count
| head 10
| eval pii_types=mvjoin(pii_types, ", ")
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="critical">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="0" midType="number" midValue="5" maxType="number" maxValue="10"></scale>
        </format>
        <format type="color" field="high">
          <colorPalette type="minMidMax" maxColor="#F58F39" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="0" midType="number" midValue="5" maxType="number" maxValue="10"></scale>
        </format>
        <drilldown>
          <set token="selected_sourcetype">$row.sourcetype$</set>
          <set token="show_details">true</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Recent Findings -->
  <row>
    <panel>
      <title>Recent PII Findings (Last 100)</title>
      <table id="pii_findings_table">
        <search>
          <query>
| inputlookup pii_findings_lookup
| search severity=$selected_severity$ status=$selected_status$
| eval timestamp_readable=strftime(timestamp, "%Y-%m-%d %H:%M:%S")
| sort - timestamp
| head 100
| table finding_id, timestamp_readable, pii_type, severity, status, index, sourcetype, event_count, masked_value, notes
| rename timestamp_readable as "Detection Time", pii_type as "PII Type", severity as "Severity", status as "Status", index as "Index", sourcetype as "Sourcetype", event_count as "Event Count", masked_value as "Masked Value", notes as "Notes"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>
        <option name="dataOverlayMode">none</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"critical":"#D93F3C","high":"#F58F39","medium":"#F7BC38","low":"#65A637"}</colorPalette>
        </format>
        <format type="color" field="Status">
          <colorPalette type="map">{"detected":"#F7BC38","flagged":"#F58F39","remediated":"#65A637","whitelisted":"#6DB7C6"}</colorPalette>
        </format>
        <drilldown>
          <set token="selected_finding_id">$row.finding_id$</set>
          <set token="show_finding_modal">true</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Action Buttons Row -->
  <!-- IMPORTANT: No onclick handlers - events are bound via jQuery in pii_detection.js -->
  <row>
    <panel>
      <html>
        <div class="action-buttons-container" style="padding: 20px; text-align: center;">
          <button class="btn btn-primary" id="run_scan_btn" style="margin: 5px;">
            <i class="icon-search"></i> Run PII Scan
          </button>
          <button class="btn btn-default" id="export_findings_btn" style="margin: 5px;">
            <i class="icon-download"></i> Export Findings
          </button>
          <button class="btn btn-default" id="view_whitelist_btn" style="margin: 5px;">
            <i class="icon-list"></i> Manage Whitelist
          </button>
          <button class="btn btn-default" id="view_settings_btn" style="margin: 5px;">
            <i class="icon-gear"></i> Settings
          </button>
        </div>
        <div id="pii_action_feedback"></div>
      </html>
    </panel>
  </row>
</dashboard>
