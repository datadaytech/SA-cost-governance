# ==========================================
# Scheduled PII Detection Searches
# ==========================================

# Daily PII Scan - Main detection search
[PII Detection - Daily Scan]
description = Scans configured indexes for PII patterns and creates findings
search = `pii_scan_indexes` `exclude_internal_indexes` earliest=-24h@h latest=now \
| head 100000 \
| `scan_all_pii` \
| where has_pii=1 \
| stats count as event_count, values(_raw) as sample_events by index, sourcetype, source, host \
| eval scan_id=md5(now().index.sourcetype) \
| foreach has_* \
    [| eval pii_types=if('<<FIELD>>'=1, mvappend(pii_types, replace("<<FIELD>>", "has_", "")), pii_types)] \
| mvexpand pii_types \
| rename pii_types as pii_type \
| eval finding_id=md5(index.sourcetype.pii_type.now()) \
| eval timestamp=now() \
| eval status="detected" \
| eval severity=case(\
    pii_type="ssn", "critical",\
    pii_type="credit_card", "critical",\
    pii_type="bank_account", "critical",\
    pii_type="passport", "critical",\
    pii_type="drivers_license", "high",\
    pii_type="mrn", "high",\
    pii_type="dob", "high",\
    pii_type="phone", "medium",\
    pii_type="email", "medium",\
    pii_type="ip", "low",\
    1=1, "medium") \
| eval masked_value="***REDACTED***" \
| lookup pii_whitelist_lookup pii_type index sourcetype OUTPUT whitelist_id \
| where isnull(whitelist_id) \
| fields - whitelist_id \
| table finding_id, timestamp, index, sourcetype, source, host, pii_type, event_count, severity, status, masked_value \
| outputlookup append=true pii_findings_lookup
cron_schedule = 0 2 * * *
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
is_scheduled = 1
enableSched = 1
disabled = 0

# Critical PII Alert - Immediate notification for SSN/CC
[PII Detection - Critical Alert]
description = Alerts on detection of critical PII (SSN, Credit Cards, Passports)
search = `pii_scan_indexes` `exclude_internal_indexes` earliest=-1h@h latest=now \
| `scan_all_pii` \
| where has_ssn=1 OR has_credit_card=1 \
| stats count as event_count by index, sourcetype, source, host \
| eval pii_types=case(\
    has_ssn=1, "SSN",\
    has_credit_card=1, "Credit Card",\
    1=1, "Unknown") \
| eval severity="CRITICAL" \
| eval alert_time=strftime(now(), "%Y-%m-%d %H:%M:%S")
cron_schedule = */30 * * * *
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
is_scheduled = 1
enableSched = 1
disabled = 0
alert.track = 1
alert.severity = 5
action.email = 1
action.email.to = admin@example.com
action.email.subject = CRITICAL: PII Detected - $result.pii_types$ in $result.index$
action.email.message.alert = Critical PII has been detected:\n\nPII Type: $result.pii_types$\nIndex: $result.index$\nSourcetype: $result.sourcetype$\nEvent Count: $result.event_count$\nSeverity: $result.severity$\n\nPlease review immediately in the PII Detection dashboard.

# PII Statistics Summary - Populate dashboard cache
[PII Detection - Statistics Summary]
description = Generates summary statistics for PII findings dashboard
search = inputlookup pii_findings_lookup \
| stats count as total_findings,\
    dc(index) as affected_indexes,\
    dc(sourcetype) as affected_sourcetypes,\
    count(eval(severity="critical")) as critical_count,\
    count(eval(severity="high")) as high_count,\
    count(eval(severity="medium")) as medium_count,\
    count(eval(severity="low")) as low_count,\
    count(eval(status="detected")) as detected_count,\
    count(eval(status="flagged")) as flagged_count,\
    count(eval(status="remediated")) as remediated_count \
    by pii_type \
| eval last_updated=now() \
| outputlookup pii_scan_cache_lookup
cron_schedule = */15 * * * *
is_scheduled = 1
enableSched = 1
disabled = 0

# PII Trend Analysis - Historical trending
[PII Detection - Trend Analysis]
description = Analyzes PII detection trends over time
search = inputlookup pii_findings_lookup \
| eval day=strftime(timestamp, "%Y-%m-%d") \
| stats count as findings_count by day, pii_type, severity \
| eval last_updated=now() \
| outputlookup append=true pii_scan_cache_lookup
cron_schedule = 0 3 * * *
is_scheduled = 1
enableSched = 1
disabled = 0

# Whitelist Cleanup - Remove expired entries
[PII Detection - Whitelist Cleanup]
description = Removes expired whitelist entries
search = inputlookup pii_whitelist_lookup \
| where isnull(expires) OR expires > now() \
| outputlookup pii_whitelist_lookup
cron_schedule = 0 4 * * *
is_scheduled = 1
enableSched = 1
disabled = 0

# ==========================================
# On-Demand Searches (disabled by default)
# ==========================================

# Deep PII Scan - Comprehensive scan (resource intensive)
[PII Detection - Deep Scan]
description = Comprehensive PII scan across all data (run manually)
search = `pii_scan_indexes` `exclude_internal_indexes` earliest=-7d@d latest=now \
| `scan_all_pii` \
| where has_pii=1 \
| stats count as event_count,\
    values(_raw) as sample_events,\
    earliest(_time) as first_seen,\
    latest(_time) as last_seen \
    by index, sourcetype, source, host \
| eval scan_id=md5(now().index.sourcetype) \
| eval finding_id=md5(index.sourcetype.now()) \
| eval timestamp=now() \
| eval status="detected" \
| `calculate_pii_severity` \
| outputlookup append=true pii_findings_lookup
is_scheduled = 0
enableSched = 0
disabled = 1

# Field-Level PII Analysis
[PII Detection - Field Analysis]
description = Analyzes specific fields for PII content
search = `pii_scan_indexes` `exclude_internal_indexes` earliest=-24h@h latest=now \
| head 10000 \
| foreach * \
    [| eval has_pii_<<FIELD>>=case(\
        match('<<FIELD>>', "`pii_ssn_pattern`"), "ssn",\
        match('<<FIELD>>', "`pii_credit_card_pattern`"), "credit_card",\
        match('<<FIELD>>', "`pii_email_pattern`"), "email",\
        match('<<FIELD>>', "`pii_phone_us_pattern`"), "phone",\
        1=1, null())] \
| foreach has_pii_* \
    [| where isnotnull('<<FIELD>>')] \
| stats count by index, sourcetype
is_scheduled = 0
enableSched = 0
disabled = 1

# Sample Event Extractor - Get samples for review
[PII Detection - Sample Extractor]
description = Extracts sample events containing PII for review
search = `pii_scan_indexes` `exclude_internal_indexes` earliest=-1h@h latest=now \
| `scan_all_pii` \
| where has_pii=1 \
| eval pii_found=case(\
    has_ssn=1, "SSN",\
    has_credit_card=1, "Credit Card",\
    has_email=1, "Email",\
    has_phone=1, "Phone",\
    has_ip=1, "IP Address",\
    1=1, "Other") \
| `mask_ssn(_raw)` \
| `mask_credit_card(_raw)` \
| `mask_email(_raw)` \
| `mask_phone(_raw)` \
| head 100 \
| table _time, index, sourcetype, pii_found, _raw_masked
is_scheduled = 0
enableSched = 0
disabled = 1
