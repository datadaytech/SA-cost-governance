# Saved Searches for User Governance App
# These scheduled searches handle automated enforcement and notifications

# ============================================================================
# SETUP SEARCHES (Run once on first install)
# ============================================================================

[Governance - Initialize Settings]
description = Initializes default settings in KV store from CSV (run once after install)
search = | inputlookup governance_settings_default \
| lookup governance_settings_lookup setting_name OUTPUT setting_value as existing_value \
| where isnull(existing_value) \
| table setting_name, setting_value, description \
| outputlookup append=true governance_settings_lookup
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
# ENFORCEMENT SEARCHES
# ============================================================================

[Governance - Check Remediation Deadlines]
description = Checks for flagged searches that have exceeded their remediation deadline and auto-disables them
search = | inputlookup flagged_searches_lookup \
| eval auto_disable = if(status IN ("pending", "notified") AND remediation_deadline < now(), 1, 0) \
| eval status = if(auto_disable=1, "disabled", status) \
| eval notes = if(auto_disable=1, notes + " | AUTO-DISABLED: Remediation deadline exceeded on " + strftime(now(), "%Y-%m-%d %H:%M"), notes) \
| table search_name, search_owner, search_app, flagged_by, flagged_time, notification_sent, notification_time, remediation_deadline, status, reason, notes \
| outputlookup flagged_searches_lookup
cron_schedule = 0 8 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

[Governance - Report Overdue Searches]
description = Reports on searches that were auto-disabled due to missed remediation deadlines
search = | inputlookup flagged_searches_lookup \
| where status="disabled" AND match(notes, "AUTO-DISABLED") \
| eval days_overdue = round((now() - remediation_deadline) / 86400, 1) \
| where days_overdue <= 1 \
| table search_name, search_owner, search_app, flagged_time, remediation_deadline, days_overdue, reason
cron_schedule = 0 9 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now
alert.track = 1
alert.suppress = 0
alert.digest_mode = 0
counttype = number of events
quantity = 0
relation = greater than
action.email = 1
action.email.to = splunk-admins@company.com
action.email.subject = Governance Alert: $job.resultCount$ Search(es) Auto-Disabled Due to Missed Deadline
action.email.format = html
action.email.inline = 1
actions = email

[Governance - Send Initial Notifications]
description = Sends initial notification emails to owners of newly flagged searches
search = | inputlookup flagged_searches_lookup \
| where status="pending" AND notification_sent=0 \
| eval notification_needed=1 \
| table search_name, search_owner, search_app, reason, remediation_deadline
cron_schedule = 0 8,14 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now
alert.track = 1
alert.suppress = 0
alert.digest_mode = 0
counttype = number of events
quantity = 0
relation = greater than
action.email = 1
action.email.to = $result.search_owner$@company.com
action.email.subject = Action Required: Scheduled Search "$result.search_name$" Flagged for Review
action.email.message.alert = Your scheduled search "$result.search_name$" has been flagged by the Splunk governance team.\n\nReason: $result.reason$\n\nDeadline for remediation: $result.remediation_deadline$\n\nPlease review and optimize your search to avoid automatic disabling.
action.email.include.results_link = 0
action.email.include.search = 0
action.email.include.trigger = 0
action.email.include.view_link = 0
actions = email

[Governance - Send Reminder Notifications]
description = Sends reminder emails to owners with searches approaching deadline (2 days remaining)
search = | inputlookup flagged_searches_lookup \
| where status="notified" \
| eval days_remaining = round((remediation_deadline - now()) / 86400, 1) \
| where days_remaining <= 2 AND days_remaining > 0 \
| table search_name, search_owner, search_app, reason, remediation_deadline, days_remaining
cron_schedule = 0 9 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now
alert.track = 1
alert.suppress = 1
alert.suppress.fields = search_name
alert.suppress.period = 24h
counttype = number of events
quantity = 0
relation = greater than
action.email = 1
action.email.to = $result.search_owner$@company.com
action.email.subject = REMINDER: Scheduled Search "$result.search_name$" Requires Remediation - $result.days_remaining$ Days Remaining
action.email.message.alert = This is a reminder that your scheduled search "$result.search_name$" requires remediation.\n\nYou have approximately $result.days_remaining$ days remaining before automatic disabling.\n\nOriginal Reason: $result.reason$\n\nPlease address this issue promptly.
action.email.include.results_link = 0
action.email.include.search = 0
action.email.include.trigger = 0
action.email.include.view_link = 0
actions = email

[Governance - Update Notification Status]
description = Updates the status of flagged searches after initial notification is sent
search = | inputlookup flagged_searches_lookup \
| eval status = if(status="pending" AND notification_sent=0, "notified", status) \
| eval notification_sent = if(status="notified" AND notification_sent=0, 1, notification_sent) \
| eval notification_time = if(notification_sent=1 AND notification_time=0, now(), notification_time) \
| outputlookup flagged_searches_lookup
cron_schedule = 0 9,15 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
# REPORTING SEARCHES
# ============================================================================

[Governance - Weekly Summary Report]
description = Generates a weekly summary of governance activity for management review
search = | inputlookup flagged_searches_lookup \
| eval week_flagged = if(flagged_time > relative_time(now(), "-7d"), 1, 0) \
| eval week_disabled = if(status="disabled" AND notification_time > relative_time(now(), "-7d"), 1, 0) \
| eval week_resolved = if(status="resolved" AND notification_time > relative_time(now(), "-7d"), 1, 0) \
| stats sum(week_flagged) as searches_flagged_this_week, sum(week_disabled) as searches_disabled_this_week, sum(week_resolved) as searches_resolved_this_week, count(eval(status="notified")) as pending_remediation \
| eval report_date = strftime(now(), "%Y-%m-%d") \
| table report_date, searches_flagged_this_week, searches_disabled_this_week, searches_resolved_this_week, pending_remediation
cron_schedule = 0 8 * * 1
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -7d
dispatch.latest_time = now
action.email = 1
action.email.to = splunk-admins@company.com
action.email.subject = Weekly Governance Report - Scheduled Search Management
action.email.format = html
action.email.inline = 1
actions = email

[Governance - Identify New Suspicious Searches]
description = Daily scan for newly suspicious scheduled searches not yet flagged
search = `analyze_scheduled_searches` \
| search is_suspicious=1 disabled=0 \
| lookup flagged_searches_lookup search_name as title OUTPUT status as flag_status \
| where isnull(flag_status) OR flag_status="resolved" \
| table title, owner, app, cron_schedule, frequency_label, avg_runtime_display, runtime_ratio, suspicious_reason \
| rename title as search_name, owner as search_owner, app as search_app
cron_schedule = 0 7 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -24h
dispatch.latest_time = now
alert.track = 1
counttype = number of events
quantity = 5
relation = greater than
action.email = 1
action.email.to = splunk-admins@company.com
action.email.subject = Governance Alert: $job.resultCount$ New Suspicious Scheduled Searches Identified
action.email.format = html
action.email.inline = 1
actions = email

[Governance - Detect Remediated Searches]
description = Automatically detects flagged searches that are no longer suspicious and marks them for admin review
search = | inputlookup flagged_searches_lookup \
| search status IN ("pending", "notified") \
| rename search_name as title \
| join type=left title [| inputlookup governance_search_cache.csv | table title, is_suspicious, runtime_ratio, frequency_seconds, cron_schedule] \
| eval was_fixed = if(is_suspicious=0 OR isnull(is_suspicious), 1, 0) \
| where was_fixed=1 \
| eval status = "review" \
| eval notes = notes + " | AUTO-DETECTED: Search no longer suspicious on " + strftime(now(), "%Y-%m-%d %H:%M") + " - awaiting admin review" \
| eval review_detected_time = now() \
| rename title as search_name \
| table search_name, search_owner, search_app, flagged_by, flagged_time, notification_sent, notification_time, remediation_deadline, status, reason, notes, review_detected_time
cron_schedule = 0 10 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

[Governance - Update Remediated Status]
description = Updates flagged searches to review status when they are no longer suspicious
search = | inputlookup flagged_searches_lookup \
| eval orig_status = status \
| join type=left search_name [| inputlookup governance_search_cache.csv | rename title as search_name | table search_name, is_suspicious] \
| eval auto_review = if(orig_status IN ("pending", "notified") AND (is_suspicious=0 OR isnull(is_suspicious)), 1, 0) \
| eval status = if(auto_review=1, "review", status) \
| eval notes = if(auto_review=1, notes + " | AUTO-DETECTED: No longer suspicious on " + strftime(now(), "%Y-%m-%d %H:%M"), notes) \
| table search_name, search_owner, search_app, flagged_by, flagged_time, notification_sent, notification_time, remediation_deadline, status, reason, notes \
| outputlookup flagged_searches_lookup
cron_schedule = 0 11 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
# MAINTENANCE SEARCHES
# ============================================================================

[Governance - Cleanup Old Resolved Entries]
description = Removes resolved entries from KV store older than 90 days
search = | inputlookup flagged_searches_lookup \
| where NOT (status="resolved" AND flagged_time < relative_time(now(), "-90d")) \
| outputlookup flagged_searches_lookup
cron_schedule = 0 2 * * 0
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

[Governance - Cleanup Old Audit Logs]
description = Removes audit log entries older than 1 year
search = | inputlookup governance_audit_log_lookup \
| where timestamp > relative_time(now(), "-365d") \
| outputlookup governance_audit_log_lookup
cron_schedule = 0 3 1 * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
# CACHE POPULATION SEARCHES
# These scheduled searches pre-compute expensive queries for faster dashboard loading
# ============================================================================

[Governance - Populate Search Cache]
description = Pre-computes scheduled search analysis including suspicious indicators and costs. Refreshed every 4 hours. Searches are dynamically re-evaluated so fixes to search patterns will remove them from suspicious status.
search = | rest /servicesNS/-/-/saved/searches splunk_server=local \
| search is_scheduled=1 \
| rename eai:acl.owner as owner, eai:acl.app as app \
| table title, owner, app, cron_schedule, disabled, dispatch.earliest_time, dispatch.latest_time, qualifiedSearch \
| join type=left title [| rest /servicesNS/-/-/search/jobs splunk_server=local | search savedsearch_name=* | stats avg(runDuration) as avg_runtime_sec count as run_count by savedsearch_name | rename savedsearch_name as title] \
| `parse_cron_frequency` \
| `calculate_suspicious_indicators` \
| `calculate_search_costs` \
| eval avg_runtime_display = if(isnotnull(avg_runtime_sec), tostring(round(avg_runtime_sec, 1))."s", "N/A") \
| eval cache_time = now() \
| outputlookup governance_search_cache.csv
cron_schedule = 0 */4 * * *
is_scheduled = 1
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now
dispatch.ttl = 86400
auto_cancel = 0

# ============================================================================
# TEST SEARCHES FOR GOVERNANCE DEMO
# These scheduled searches demonstrate various scenarios for governance review
# ============================================================================

[Governance_Test_Search_01_Normal]
description = Normal daily search - low resource usage (~20 SVC)
search = | makeresults count=100 | eval host="test_host_".random()%10 | stats count by host | head 10
cron_schedule = 0 6 * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -24h
dispatch.latest_time = now

[Governance_Test_Search_02_Normal_Hourly]
description = Normal hourly search - moderate resource usage (~22 SVC)
search = | makeresults count=500 | eval index="main", sourcetype="test" | stats count | eval result="OK"
cron_schedule = 0 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -1h
dispatch.latest_time = now

[Governance_Test_Search_03_High_Freq]
description = High frequency search - runs every 5 minutes (~85 SVC) - SUSPICIOUS
search = | makeresults count=1000 | streamstats count | eval data=random() | stats avg(data) as avg_val, max(data) as max_val, min(data) as min_val
cron_schedule = */5 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -5m
dispatch.latest_time = now

[Governance_Test_Search_04_Very_High_Freq]
description = Very high frequency search - runs every minute (~110 SVC) - CRITICAL
search = | makeresults count=2000 | eval index="*", source="*" | transaction host maxspan=1m | stats count by host
cron_schedule = */1 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -1m
dispatch.latest_time = now

[Governance_Test_Search_05_Long_Runtime]
description = Long running search with 30 day time range (~95 SVC) - SUSPICIOUS
search = | makeresults count=5000 | eval _time=_time-random()%2592000 | bucket _time span=1d | stats count by _time | sort _time
cron_schedule = 0 2 * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -30d
dispatch.latest_time = now

[Governance_Test_Search_06_Index_Wildcard]
description = Search using index=* wildcard (~100 SVC) - WASTEFUL
search = index=* sourcetype=* | stats count by index, sourcetype | head 50
cron_schedule = 30 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -1h
dispatch.latest_time = now

[Governance_Test_Search_07_Join_Heavy]
description = Search with expensive join operation (~90 SVC) - SUSPICIOUS
search = | makeresults count=1000 | eval id=random()%100 | join type=left id [| makeresults count=500 | eval id=random()%100, data=random()]
cron_schedule = */15 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -15m
dispatch.latest_time = now

[Governance_Test_Search_08_Transaction_Heavy]
description = Search with transaction command (~88 SVC) - SUSPICIOUS
search = | makeresults count=2000 | eval host="host_".random()%5, session=random()%100 | transaction session maxspan=5m | stats count by host
cron_schedule = */10 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -10m
dispatch.latest_time = now

[Governance_Test_Search_09_Normal_Weekly]
description = Normal weekly report - low resource usage (~18 SVC)
search = | makeresults count=50 | eval week=strftime(now(), "%Y-W%W") | stats count | eval status="weekly_report_complete"
cron_schedule = 0 8 * * 1
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -7d
dispatch.latest_time = now

[Governance_Test_Search_10_90Day_Range]
description = Expensive 90-day historical search (~120 SVC) - CRITICAL
search = | makeresults count=10000 | eval _time=_time-random()%7776000 | timechart span=1d count | stats sum(count) as total
cron_schedule = 0 3 * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -90d
dispatch.latest_time = now

[Governance_Test_Search_11_Normal_15Min]
description = Normal 15-minute interval search (~25 SVC)
search = | makeresults count=200 | eval metric=random()%1000 | stats avg(metric) as avg_metric, p95(metric) as p95_metric
cron_schedule = */15 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -15m
dispatch.latest_time = now

[Governance_Test_Search_12_AppendHeavy]
description = Search with multiple append operations (~82 SVC) - SUSPICIOUS
search = | makeresults count=100 | append [| makeresults count=100] | append [| makeresults count=100] | append [| makeresults count=100] | stats count
cron_schedule = */30 * * * *
is_scheduled = 0
enableSched = 0
dispatch.earliest_time = -30m
dispatch.latest_time = now
