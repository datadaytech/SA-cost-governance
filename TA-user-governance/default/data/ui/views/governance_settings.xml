<dashboard version="1.1" theme="dark" script="governance.js" stylesheet="governance.css">
  <label>Governance Settings</label>
  <description>Configure licensing costs, thresholds, and preferences for scheduled search governance</description>

  <!-- Step 1: Data Refresh Settings -->
  <row>
    <panel>
      <html>
        <div style="background: linear-gradient(135deg, rgba(0,109,156,0.2) 0%, rgba(0,212,255,0.1) 100%); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 20px;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <span style="background: #00d4ff; color: #111; font-weight: 700; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">1</span>
            <h3 style="color: #00d4ff; margin: 0;">Data Refresh Settings</h3>
          </div>
          <p style="color: rgba(255,255,255,0.8); margin-bottom: 16px;">Configure when the governance cache is refreshed. The cache pre-computes scheduled search analysis for faster dashboard loading.</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Cache Refresh Schedule</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Choose how often the governance data is refreshed. More frequent updates mean more accurate data but higher resource usage.</p>
      </html>
      <input type="dropdown" token="cache_schedule" searchWhenChanged="false">
        <label>Refresh Frequency</label>
        <choice value="*/5 * * * *">Every 5 minutes (High accuracy)</choice>
        <choice value="*/15 * * * *">Every 15 minutes (Balanced)</choice>
        <choice value="*/30 * * * *">Every 30 minutes (Low impact)</choice>
        <choice value="0 * * * *">Hourly</choice>
        <choice value="0 2 * * *">Daily at 2:00 AM (Recommended for low volume)</choice>
        <choice value="0 6 * * *">Daily at 6:00 AM</choice>
        <default>*/5 * * * *</default>
      </input>
      <html>
        <form class="settings-form" style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn btn-primary" onclick="updateCacheSchedule('$cache_schedule$')">Save Schedule</button>
          <button class="btn" style="background: #53a051; border-color: #53a051;" onclick="runCacheNow()">Run Cache Now</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>Last Cache Refresh</title>
      <single>
        <search>
          <query>| inputlookup governance_search_cache.csv
| stats max(cache_time) as last_refresh count as total_searches
| eval time_since = now() - last_refresh
| eval time_ago = case(
    time_since &lt; 60, round(time_since) . " seconds ago",
    time_since &lt; 3600, round(time_since/60) . " minutes ago",
    time_since &lt; 86400, round(time_since/3600, 1) . " hours ago",
    1=1, round(time_since/86400, 1) . " days ago")
| eval last_refresh_display = if(isnotnull(last_refresh), strftime(last_refresh, "%b %d, %Y %H:%M"), "Never")
| eval display = if(isnotnull(last_refresh), last_refresh_display . " (" . time_ago . ")", "Never")
| eval searches_count = total_searches . " searches"
| table display, searches_count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="useColors">0</option>
        <option name="underLabel">$result.searches_count$</option>
      </single>
    </panel>
  </row>

  <!-- Divider -->
  <row>
    <panel>
      <html><hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;" /></html>
    </panel>
  </row>

  <!-- Step 2: Licensing Model Selection -->
  <row>
    <panel>
      <html>
        <div style="background: linear-gradient(135deg, rgba(0,109,156,0.2) 0%, rgba(0,212,255,0.1) 100%); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 20px;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <span style="background: #00d4ff; color: #111; font-weight: 700; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">2</span>
            <h3 style="color: #00d4ff; margin: 0;">Splunk Licensing Model</h3>
          </div>
          <p style="color: rgba(255,255,255,0.8); margin-bottom: 16px;">Select your organization's Splunk Cloud licensing model. This determines which cost metrics are used for analysis.</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Select Licensing Model</title>
      <input type="radio" token="licensing_model" searchWhenChanged="true">
        <label>Licensing Model</label>
        <choice value="workload">Workload Pricing (SVC-based)</choice>
        <choice value="ingest">Ingest Pricing (GB-based)</choice>
        <default>workload</default>
        <change>
          <condition value="workload">
            <set token="show_workload">true</set>
            <unset token="show_ingest"></unset>
          </condition>
          <condition value="ingest">
            <unset token="show_workload"></unset>
            <set token="show_ingest">true</set>
          </condition>
        </change>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('licensing_model', '$licensing_model$', 'Selected licensing model (workload or ingest)')">Save Licensing Model</button>
        </form>
      </html>
    </panel>
  </row>

  <!-- Workload Pricing Settings (SVC-based) -->
  <row depends="$show_workload$">
    <panel>
      <title>SVC (Splunk Virtual Compute) Settings</title>
      <html>
        <div style="background: rgba(83,160,81,0.1); border: 1px solid rgba(83,160,81,0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <p style="margin: 0; color: rgba(255,255,255,0.8);"><strong>SVCs</strong> are compute units for search processing. Each search consumes SVCs based on complexity and data volume.</p>
        </div>
      </html>
      <input type="text" token="svc_unit_cost" searchWhenChanged="false">
        <label>Cost per SVC ($)</label>
        <default>0.10</default>
      </input>
      <input type="text" token="svc_purchased" searchWhenChanged="false">
        <label>Monthly SVCs Purchased</label>
        <default>10000</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('svc_unit_cost', '$svc_unit_cost$', 'Cost per SVC in dollars'); updateSetting('svc_purchased', '$svc_purchased$', 'Monthly SVCs purchased');">Save SVC Settings</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>DDAS (Dynamic Data Active Search) Settings</title>
      <html>
        <div style="background: rgba(83,160,81,0.1); border: 1px solid rgba(83,160,81,0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <p style="margin: 0; color: rgba(255,255,255,0.8);"><strong>DDAS</strong> pricing applies to searches over accelerated data models and tstats queries.</p>
        </div>
      </html>
      <input type="text" token="ddas_unit_cost" searchWhenChanged="false">
        <label>Cost per DDAS Query ($)</label>
        <default>0.05</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('ddas_unit_cost', '$ddas_unit_cost$', 'Cost per DDAS query')">Save DDAS Settings</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>DDAA (Dynamic Data Active Archive) Settings</title>
      <html>
        <div style="background: rgba(83,160,81,0.1); border: 1px solid rgba(83,160,81,0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <p style="margin: 0; color: rgba(255,255,255,0.8);"><strong>DDAA</strong> pricing applies to searches against archived/frozen data tiers.</p>
        </div>
      </html>
      <input type="text" token="ddaa_unit_cost" searchWhenChanged="false">
        <label>Cost per DDAA Query ($)</label>
        <default>0.15</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('ddaa_unit_cost', '$ddaa_unit_cost$', 'Cost per DDAA archive query')">Save DDAA Settings</button>
        </form>
      </html>
    </panel>
  </row>

  <!-- Ingest Pricing Settings (GB-based) -->
  <row depends="$show_ingest$">
    <panel>
      <title>Ingest Volume Pricing</title>
      <html>
        <div style="background: rgba(0,109,156,0.1); border: 1px solid rgba(0,109,156,0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <p style="margin: 0; color: rgba(255,255,255,0.8);"><strong>Ingest pricing</strong> is based on the volume of data indexed per day. Cost calculations will use estimated data scanned per search.</p>
        </div>
      </html>
      <input type="text" token="ingest_gb_cost" searchWhenChanged="false">
        <label>Cost per GB Ingested ($)</label>
        <default>15.00</default>
      </input>
      <input type="text" token="daily_ingest_gb" searchWhenChanged="false">
        <label>Daily Ingest Volume (GB)</label>
        <default>100</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('ingest_gb_cost', '$ingest_gb_cost$', 'Cost per GB ingested'); updateSetting('daily_ingest_gb', '$daily_ingest_gb$', 'Daily ingest volume in GB');">Save Ingest Settings</button>
        </form>
      </html>
    </panel>
  </row>

  <!-- Current Cost Configuration Display -->
  <row>
    <panel>
      <title>Your Current Cost Configuration</title>
      <table id="cost_config_table">
        <search>
          <query>| inputlookup governance_settings_lookup
| search setting_name IN ("licensing_model", "svc_unit_cost", "svc_purchased", "ddas_unit_cost", "ddaa_unit_cost", "ingest_gb_cost", "daily_ingest_gb")
| append [| makeresults | eval setting_name="licensing_model", setting_value="workload", description="Licensing model" | fields - _time]
| append [| makeresults | eval setting_name="svc_unit_cost", setting_value="0.10", description="Cost per SVC" | fields - _time]
| append [| makeresults | eval setting_name="svc_purchased", setting_value="10000", description="Monthly SVCs purchased" | fields - _time]
| append [| makeresults | eval setting_name="ddas_unit_cost", setting_value="0.05", description="Cost per DDAS query" | fields - _time]
| append [| makeresults | eval setting_name="ddaa_unit_cost", setting_value="0.15", description="Cost per DDAA query" | fields - _time]
| append [| makeresults | eval setting_name="ingest_gb_cost", setting_value="15.00", description="Cost per GB ingested" | fields - _time]
| append [| makeresults | eval setting_name="daily_ingest_gb", setting_value="100", description="Daily ingest volume (GB)" | fields - _time]
| dedup setting_name
| eval display_name = case(
    setting_name="licensing_model", "Licensing Model",
    setting_name="svc_unit_cost", "SVC Unit Cost",
    setting_name="svc_purchased", "Monthly SVCs Purchased",
    setting_name="ddas_unit_cost", "DDAS Unit Cost",
    setting_name="ddaa_unit_cost", "DDAA Unit Cost",
    setting_name="ingest_gb_cost", "Ingest Cost per GB",
    setting_name="daily_ingest_gb", "Daily Ingest Volume",
    1=1, setting_name)
| eval display_value = case(
    setting_name="licensing_model", upper(substr(setting_value, 1, 1)) . substr(setting_value, 2) . " Pricing",
    setting_name="svc_purchased" OR setting_name="daily_ingest_gb", setting_value,
    1=1, "$" . setting_value)
| eval sort_order = case(setting_name="licensing_model", 1, setting_name="svc_unit_cost", 2, setting_name="svc_purchased", 3, setting_name="ddas_unit_cost", 4, setting_name="ddaa_unit_cost", 5, setting_name="ingest_gb_cost", 6, setting_name="daily_ingest_gb", 7, 1=1, 99)
| sort sort_order
| table display_name, display_value, description
| rename display_name as "Setting", display_value as "Current Value", description as "Description"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <!-- Divider -->
  <row>
    <panel>
      <html><hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;" /></html>
    </panel>
  </row>

  <!-- Step 3: Governance Thresholds -->
  <row>
    <panel>
      <html>
        <div style="background: linear-gradient(135deg, rgba(0,109,156,0.2) 0%, rgba(0,212,255,0.1) 100%); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 20px;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <span style="background: #00d4ff; color: #111; font-weight: 700; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">3</span>
            <h3 style="color: #00d4ff; margin: 0;">Governance Thresholds</h3>
          </div>
          <p style="color: rgba(255,255,255,0.8); margin-bottom: 0;">Configure thresholds for identifying suspicious scheduled searches. Searches exceeding these thresholds will be flagged for review.</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Runtime Ratio Threshold</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Maximum runtime as % of schedule interval. Searches exceeding this are flagged.</p>
      </html>
      <input type="text" token="new_runtime_ratio" searchWhenChanged="false">
        <label>Threshold (%)</label>
        <default>10</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('runtime_ratio_threshold', '$new_runtime_ratio$', 'Max runtime as % of schedule')">Save</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>High Frequency Threshold</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Minimum interval between runs. Faster schedules are flagged.</p>
      </html>
      <input type="dropdown" token="new_frequency_threshold" searchWhenChanged="false">
        <label>Minimum Interval</label>
        <choice value="60">1 Minute</choice>
        <choice value="300">5 Minutes</choice>
        <choice value="600">10 Minutes</choice>
        <choice value="900">15 Minutes</choice>
        <choice value="1800">30 Minutes</choice>
        <choice value="3600">1 Hour</choice>
        <default>900</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('high_frequency_threshold', '$new_frequency_threshold$', 'Min seconds between runs')">Save</button>
        </form>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Long Runtime Threshold</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Maximum average runtime before flagging as long-running.</p>
      </html>
      <input type="dropdown" token="new_runtime_threshold" searchWhenChanged="false">
        <label>Maximum Runtime</label>
        <choice value="60">1 Minute</choice>
        <choice value="120">2 Minutes</choice>
        <choice value="180">3 Minutes</choice>
        <choice value="300">5 Minutes</choice>
        <choice value="600">10 Minutes</choice>
        <choice value="900">15 Minutes</choice>
        <default>300</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('long_runtime_threshold', '$new_runtime_threshold$', 'Runtime threshold in seconds')">Save</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>Remediation Period</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Days before flagged searches are auto-disabled.</p>
      </html>
      <input type="dropdown" token="new_remediation_days" searchWhenChanged="false">
        <label>Days to Remediate</label>
        <choice value="3">3 Days</choice>
        <choice value="5">5 Days</choice>
        <choice value="7">7 Days</choice>
        <choice value="14">14 Days</choice>
        <choice value="30">30 Days</choice>
        <default>7</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('remediation_days', '$new_remediation_days$', 'Days for remediation')">Save</button>
        </form>
      </html>
    </panel>
  </row>

  <!-- Divider -->
  <row>
    <panel>
      <html><hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;" /></html>
    </panel>
  </row>

  <!-- Step 4: Notification Settings -->
  <row>
    <panel>
      <html>
        <div style="background: linear-gradient(135deg, rgba(0,109,156,0.2) 0%, rgba(0,212,255,0.1) 100%); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 20px;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <span style="background: #00d4ff; color: #111; font-weight: 700; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">4</span>
            <h3 style="color: #00d4ff; margin: 0;">Notification Settings</h3>
          </div>
          <p style="color: rgba(255,255,255,0.8); margin-bottom: 0;">Configure email notifications for search owners and admin alerts.</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>Email Domain</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Domain appended to usernames for owner notifications.</p>
      </html>
      <input type="text" token="email_domain" searchWhenChanged="false">
        <label>Email Domain</label>
        <default>company.com</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('email_domain', '$email_domain$', 'Email domain for notifications')">Save</button>
        </form>
      </html>
    </panel>
    <panel>
      <title>Admin Email</title>
      <html>
        <p style="color: rgba(255,255,255,0.7);">Admin team email for weekly reports and alerts.</p>
      </html>
      <input type="text" token="admin_email" searchWhenChanged="false">
        <label>Admin Email Address</label>
        <default>splunk-admins@company.com</default>
      </input>
      <html>
        <form class="settings-form">
          <button class="btn btn-primary" onclick="updateSetting('admin_email', '$admin_email$', 'Admin notification email')">Save</button>
        </form>
      </html>
    </panel>
  </row>

  <!-- Divider -->
  <row>
    <panel>
      <html><hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;" /></html>
    </panel>
  </row>

  <!-- Statistics -->
  <row>
    <panel>
      <title>Flagged Search Statistics</title>
      <single>
        <search>
          <query>| inputlookup flagged_searches_lookup | stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Total Flagged</option>
      </single>
    </panel>
    <panel>
      <title>Pending Remediation</title>
      <single>
        <search>
          <query>| inputlookup flagged_searches_lookup | search status="pending" OR status="notified" | stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Awaiting Action</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[3,7]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Auto-Disabled</title>
      <single>
        <search>
          <query>| inputlookup flagged_searches_lookup | search status="disabled" | stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">By Governance</option>
      </single>
    </panel>
    <panel>
      <title>Audit Actions</title>
      <single>
        <search>
          <query>| inputlookup governance_audit_log_lookup | stats count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Total Actions Logged</option>
      </single>
    </panel>
  </row>

  <!-- Reference Information -->
  <row>
    <panel>
      <title>Detected Wasteful SPL Patterns</title>
      <html>
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px;">
          <p style="color: rgba(255,255,255,0.7); margin-bottom: 12px;"><strong>Default Patterns</strong> (automatically detected):</p>
          <table style="width: 100%; color: rgba(255,255,255,0.8); margin-bottom: 15px;">
            <tr><td style="padding: 6px 0;"><code style="background: rgba(0,109,156,0.3); padding: 2px 8px; border-radius: 3px;">index=*</code></td><td>Searches scanning all indexes</td></tr>
            <tr><td style="padding: 6px 0;"><code style="background: rgba(0,109,156,0.3); padding: 2px 8px; border-radius: 3px;">| join</code></td><td>Expensive join operations</td></tr>
            <tr><td style="padding: 6px 0;"><code style="background: rgba(0,109,156,0.3); padding: 2px 8px; border-radius: 3px;">| transaction</code></td><td>Transaction commands</td></tr>
            <tr><td style="padding: 6px 0;"><code style="background: rgba(0,109,156,0.3); padding: 2px 8px; border-radius: 3px;">earliest=-30d+</code></td><td>Extended time ranges (30+ days)</td></tr>
          </table>

          <p style="color: rgba(255,255,255,0.7); margin-bottom: 8px;"><strong>Add Custom Pattern</strong>:</p>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="custom_pattern_input" placeholder="Enter SPL pattern (e.g., | append)"
                   style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: #fff;"/>
            <input type="text" id="custom_pattern_desc" placeholder="Description"
                   style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: #fff;"/>
            <button class="btn btn-primary" onclick="addWastefulPattern()">Add Pattern</button>
          </div>

          <div id="custom_patterns_list" style="margin-top: 10px;">
            <p style="color: rgba(255,255,255,0.5); font-style: italic;">Loading custom patterns...</p>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- JavaScript -->
  <row>
    <html>
      <script>
        function updateSetting(settingName, settingValue, description) {
          if (!settingValue || settingValue.indexOf('$') === 0) {
            alert('Please enter a valid value');
            return;
          }

          var searchQuery = '| inputlookup governance_settings_lookup ' +
            '| append [| makeresults | eval setting_name="' + settingName + '", setting_value="' + settingValue + '", description="' + description + '" | fields - _time] ' +
            '| dedup setting_name ' +
            '| outputlookup governance_settings_lookup';

          require(['splunkjs/mvc/searchmanager', 'splunkjs/mvc'], function(SearchManager, mvc) {
            var updateSearch = new SearchManager({
              id: 'update_setting_' + Date.now(),
              search: searchQuery,
              earliest_time: '-1h',
              latest_time: 'now',
              autostart: true
            });

            updateSearch.on('search:done', function() {
              showToast('Setting "' + settingName + '" saved successfully');
            });

            updateSearch.on('search:error', function(err) {
              alert('Error updating setting: ' + err);
            });
          });
        }

        function updateCacheSchedule(schedule) {
          if (!schedule || schedule.indexOf('$') === 0) {
            alert('Please select a schedule');
            return;
          }

          require(['splunkjs/mvc/searchmanager', 'splunkjs/mvc'], function(SearchManager, mvc) {
            // Update the saved search cron_schedule via REST API
            var updateSearch = new SearchManager({
              id: 'update_cache_schedule_' + Date.now(),
              search: '| rest splunk_server=local /servicesNS/admin/TA-user-governance/saved/searches/Governance%20-%20Populate%20Search%20Cache ' +
                      '| eval new_cron="' + schedule + '" ' +
                      '| map maxsearches=1 search="| makeresults | eval status=\\"updating\\" | outputlookup governance_settings_lookup append=true where setting_name=\\"cache_schedule_update\\""',
              earliest_time: '-1h',
              latest_time: 'now',
              autostart: true
            });

            // Use splunkjs Service to directly update the saved search
            var service = mvc.createService();
            var savedSearches = service.savedSearches({owner: 'admin', app: 'TA-user-governance'});

            savedSearches.fetch(function(err, savedSearches) {
              if (err) {
                alert('Error fetching saved searches: ' + err);
                return;
              }

              var cacheSearch = savedSearches.item('Governance - Populate Search Cache');
              if (cacheSearch) {
                cacheSearch.update({cron_schedule: schedule}, function(err) {
                  if (err) {
                    alert('Error updating saved search schedule: ' + err);
                  } else {
                    // Also save to settings lookup for reference
                    updateSetting('cache_schedule', schedule, 'Cache refresh schedule');
                    showToast('Cache schedule updated to: ' + schedule);
                  }
                });
              } else {
                alert('Saved search "Governance - Populate Search Cache" not found');
              }
            });
          });
        }

        function runCacheNow() {
          // Run the analyze_search_costs macro and store the job SID for loadjob access
          require(['splunkjs/mvc/searchmanager', 'splunkjs/mvc'], function(SearchManager, mvc) {
            showToast('Running cost analysis cache (this may take a moment)...');

            // Run the macro with a long TTL so results persist for loadjob
            var cacheSearch = new SearchManager({
              id: 'cost_cache_' + Date.now(),
              search: '| `analyze_search_costs` | eval cache_time=now()',
              earliest_time: '-1h',
              latest_time: 'now',
              preview: false,
              cache: false,
              autostart: true
            });

            cacheSearch.on('search:done', function(props) {
              var resultCount = props.content.resultCount || 0;
              var sid = cacheSearch.job.sid;

              // Store the SID in a lookup for subsequent loadjob access
              var storeSidSearch = new SearchManager({
                id: 'store_sid_' + Date.now(),
                search: '| makeresults | eval cache_sid="' + sid + '", cache_time=now(), result_count=' + resultCount + ' | fields - _time | outputlookup governance_cache_sid_lookup',
                earliest_time: '-1h',
                latest_time: 'now',
                autostart: true
              });

              storeSidSearch.on('search:done', function() {
                showToast('Cache refreshed! SID: ' + sid.substring(0, 20) + '... (' + resultCount + ' searches)');

                // Set the job TTL to 24 hours so loadjob can access it
                setJobTTL(sid, 86400);

                setTimeout(function() { location.reload(); }, 2000);
              });
            });

            cacheSearch.on('search:error', function(err) {
              alert('Error running cache: ' + (err.message || err));
            });

            cacheSearch.on('search:fail', function(err) {
              alert('Cache failed: ' + (err.message || err));
            });
          });
        }

        function setJobTTL(sid, ttl) {
          // Set the job TTL via REST API so loadjob can access results later
          require(['jquery'], function($) {
            $.ajax({
              url: '/en-US/splunkd/__raw/services/search/jobs/' + encodeURIComponent(sid) + '/control',
              type: 'POST',
              data: { action: 'setttl', ttl: ttl },
              success: function() {
                console.log('Job TTL set to ' + ttl + ' seconds');
              },
              error: function(err) {
                console.log('Could not set job TTL:', err);
              }
            });
          });
        }

        // ============================================
        // WASTEFUL SPL PATTERNS FUNCTIONS
        // ============================================

        function addWastefulPattern() {
          var pattern = document.getElementById('custom_pattern_input').value.trim();
          var description = document.getElementById('custom_pattern_desc').value.trim() || 'Custom pattern';

          if (!pattern) {
            alert('Please enter a pattern');
            return;
          }

          require(['splunkjs/mvc/searchmanager', 'splunkjs/mvc'], function(SearchManager, mvc) {
            var escapedPattern = pattern.replace(/"/g, '\\"').replace(/\|/g, '\\|');
            var escapedDesc = description.replace(/"/g, '\\"');

            var addSearch = new SearchManager({
              id: 'add_wasteful_pattern_' + Date.now(),
              search: '| inputlookup wasteful_patterns_lookup ' +
                      '| append [| makeresults | eval pattern="' + escapedPattern + '", description="' + escapedDesc + '", added_by="' + (Splunk.util.getCurrentApp ? Splunk.util.getUsername() : 'admin') + '", added_time=now() | fields - _time] ' +
                      '| dedup pattern ' +
                      '| outputlookup wasteful_patterns_lookup',
              earliest_time: '-1h',
              latest_time: 'now',
              autostart: true
            });

            addSearch.on('search:done', function() {
              showToast('Pattern "' + pattern + '" added successfully');
              document.getElementById('custom_pattern_input').value = '';
              document.getElementById('custom_pattern_desc').value = '';
              loadWastefulPatterns();
            });

            addSearch.on('search:error', function(err) {
              alert('Error adding pattern: ' + err);
            });
          });
        }

        function removeWastefulPattern(pattern) {
          if (!confirm('Remove pattern "' + pattern + '"?')) return;

          require(['splunkjs/mvc/searchmanager'], function(SearchManager) {
            var escapedPattern = pattern.replace(/"/g, '\\"').replace(/\|/g, '\\|');

            var removeSearch = new SearchManager({
              id: 'remove_wasteful_pattern_' + Date.now(),
              search: '| inputlookup wasteful_patterns_lookup ' +
                      '| search pattern!="' + escapedPattern + '" ' +
                      '| outputlookup wasteful_patterns_lookup',
              earliest_time: '-1h',
              latest_time: 'now',
              autostart: true
            });

            removeSearch.on('search:done', function() {
              showToast('Pattern removed');
              loadWastefulPatterns();
            });
          });
        }

        function loadWastefulPatterns() {
          require(['splunkjs/mvc/searchmanager', 'splunkjs/mvc/resultslinkview'], function(SearchManager, ResultsLinkView) {
            var loadSearch = new SearchManager({
              id: 'load_wasteful_patterns_' + Date.now(),
              search: '| inputlookup wasteful_patterns_lookup | table pattern, description',
              earliest_time: '-1h',
              latest_time: 'now',
              autostart: true
            });

            loadSearch.on('search:done', function(props) {
              var results = loadSearch.data('results', {output_mode: 'json_rows'});
              if (results) {
                results.on('data', function() {
                  var rows = results.data().rows || [];
                  var container = document.getElementById('custom_patterns_list');

                  if (rows.length === 0) {
                    container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-style: italic;">No custom patterns defined</p>';
                    return;
                  }

                  var html = '<p style="color: rgba(255,255,255,0.7); margin-bottom: 8px;"><strong>Custom Patterns</strong>:</p>';
                  html += '<table style="width: 100%; color: rgba(255,255,255,0.8);">';
                  rows.forEach(function(row) {
                    var pattern = row[0];
                    var desc = row[1];
                    html += '<tr>' +
                            '<td style="padding: 6px 0;"><code style="background: rgba(0,109,156,0.3); padding: 2px 8px; border-radius: 3px;">' + pattern + '</code></td>' +
                            '<td>' + desc + '</td>' +
                            '<td style="width: 60px; text-align: right;"><button class="btn btn-default btn-small" onclick="removeWastefulPattern(\'' + pattern.replace(/'/g, "\\'") + '\')" style="padding: 2px 8px; font-size: 11px;">Remove</button></td>' +
                            '</tr>';
                  });
                  html += '</table>';
                  container.innerHTML = html;
                });
              }
            });
          });
        }

        // Load patterns on page load
        setTimeout(loadWastefulPatterns, 2000);

        function showToast(message) {
          var toast = document.createElement('div');
          toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #53a051; color: white; padding: 12px 20px; border-radius: 6px; z-index: 10000; font-weight: 500;';
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 3000);
        }
      </script>
      <style>
        .settings-form { margin-top: 10px; }
        #cost_config_table .shared-resultstable-resultstablerow { cursor: default !important; }
        #cost_config_table .shared-resultstable-resultstablerow:hover { background: transparent !important; }
      </style>
    </html>
  </row>

</dashboard>
