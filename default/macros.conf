# Cost Governance Macros
# Supporting macros for cost analysis and governance

# License usage analysis
[license_usage_index]
definition = index=_internal sourcetype=splunkd component=LicenseUsage
iseval = 0

# Get license pool info
[license_pools]
definition = | rest /services/licenser/pools splunk_server=local | table title, description, effective_quota, used_bytes, stack_id
iseval = 0

# Calculate daily license usage
[daily_license_usage(1)]
args = days
definition = index=_internal sourcetype=splunkd component=LicenseUsage type=Usage earliest=-$days$d@d latest=@d | timechart span=1d sum(b) as bytes_used | eval GB_used=round(bytes_used/1024/1024/1024, 2)
iseval = 0

# Search cost estimation (SVC-based)
[search_cost_estimate]
definition = | rest /services/search/jobs splunk_server=local | eval cost_score=case(runDuration>300, "high", runDuration>60, "medium", 1=1, "low") | table sid, label, runDuration, scanCount, eventCount, cost_score
iseval = 0

# Scheduled search inventory
[scheduled_search_inventory]
definition = | rest /servicesNS/-/-/saved/searches splunk_server=local | search is_scheduled=1 disabled=0 | table title, author, cron_schedule, dispatch.earliest_time, dispatch.latest_time, search
iseval = 0

# Heavy searches (by scan count)
[heavy_searches(1)]
args = threshold
definition = | rest /services/search/jobs splunk_server=local | where scanCount > $threshold$ | sort -scanCount | table sid, label, runDuration, scanCount, eventCount, user
iseval = 0

# Index usage by sourcetype
[index_usage_by_sourcetype]
definition = | tstats count where index=* by index, sourcetype | sort -count
iseval = 0

# User search activity
[user_search_activity(1)]
args = timerange
definition = index=_audit action=search info=granted earliest=$timerange$ | stats count as search_count by user | sort -search_count
iseval = 0

# Cost settings lookup
[cost_settings]
definition = | inputlookup cost_governance_settings.csv
iseval = 0

# Calculate estimated cost per GB
[cost_per_gb]
definition = `cost_settings` | head 1 | return $cost_per_gb
iseval = 0
