#
# Saved Searches for SA Topology Analyzer
# These searches discover infrastructure components from internal logs
#

#
# Universal Forwarder Discovery
# Finds all UFs that have sent data in the last 24 hours
#
[SA Topology - Universal Forwarders]
search = index=_internal sourcetype=splunkd group=tcpin_connections \
| stats latest(version) as version, \
        latest(arch) as architecture, \
        latest(os) as os, \
        sum(kb) as total_kb, \
        dc(sourceIp) as connection_count, \
        latest(_time) as last_seen \
        by hostname, guid \
| eval type="universal_forwarder" \
| eval last_seen_human=strftime(last_seen, "%Y-%m-%d %H:%M:%S") \
| eval health=case( \
    last_seen > relative_time(now(), "-15m"), "green", \
    last_seen > relative_time(now(), "-1h"), "yellow", \
    1=1, "red") \
| table hostname, guid, version, architecture, os, total_kb, connection_count, last_seen_human, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Alternative UF Discovery using metrics.log
# More reliable for some environments
#
[SA Topology - Universal Forwarders Alt]
search = index=_internal sourcetype=splunkd source=*metrics.log group=tcpin_connections \
| stats latest(version) as version, \
        latest(build) as build, \
        latest(fwdType) as forwarder_type, \
        sum(kb) as total_kb, \
        latest(_time) as last_seen \
        by hostname \
| where isnotnull(hostname) \
| eval type="universal_forwarder" \
| eval health=case( \
    last_seen > relative_time(now(), "-15m"), "green", \
    last_seen > relative_time(now(), "-1h"), "yellow", \
    1=1, "red") \
| table hostname, version, build, forwarder_type, total_kb, last_seen, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Index Discovery
# Finds all indexes and their data volumes
#
[SA Topology - Indexes]
search = | rest /services/data/indexes \
| search disabled=0 \
| eval size_gb=round(currentDBSizeMB/1024, 2) \
| eval type="index" \
| eval health=case( \
    currentDBSizeMB > 0 AND disabled=0, "green", \
    currentDBSizeMB = 0 AND disabled=0, "yellow", \
    1=1, "red") \
| table title, currentDBSizeMB, size_gb, totalEventCount, homePath, coldPath, maxDataSizeMB, health, type \
| rename title as index_name
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Index to Forwarder Mapping
# Shows which forwarders are sending data to which indexes
#
[SA Topology - Index Forwarder Mapping]
search = index=_internal sourcetype=splunkd group=tcpin_connections \
| stats dc(hostname) as forwarder_count, \
        values(hostname) as forwarders, \
        sum(kb) as total_kb \
        by dest_idx \
| rename dest_idx as index_name \
| eval type="index_mapping" \
| table index_name, forwarder_count, forwarders, total_kb, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Search Head Discovery
# Identifies search heads in the deployment
#
[SA Topology - Search Heads]
search = | rest /services/server/info \
| eval type="search_head" \
| eval is_shc_member=if(isnotnull(shcluster_label), "yes", "no") \
| eval health="green" \
| table serverName, version, build, os_name, cpu_arch, numberOfCores, physicalMemoryMB, is_shc_member, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Indexer Discovery
# Identifies indexers receiving data
#
[SA Topology - Indexers]
search = | rest /services/cluster/master/peers \
| eval type="indexer" \
| eval health=case( \
    status="Up", "green", \
    status="Detention", "yellow", \
    1=1, "red") \
| table label, site, status, replication_count, search_count, bucket_count, health, type \
| rename label as indexer_name
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Full Topology Data - Combined view
# This is the main search for building the topology
#
[SA Topology - Full Topology]
search = | makeresults \
| eval search_type="topology_builder" \
| append [ \
    | rest /services/server/info \
    | eval node_type="search_head", health="green" \
    | eval node_id="sh_".serverName \
    | eval parent_id="root" \
    | table node_id, serverName, node_type, health, parent_id, version \
    | rename serverName as node_name \
] \
| append [ \
    | rest /services/data/indexes \
    | search disabled=0 totalEventCount>0 \
    | eval node_type="index", health=if(currentDBSizeMB>0, "green", "yellow") \
    | eval node_id="idx_".title \
    | head 1 \
    | eval parent_id="sh_".splunk_server \
    | table node_id, title, node_type, health, parent_id, currentDBSizeMB, totalEventCount \
    | rename title as node_name \
] \
| append [ \
    index=_internal sourcetype=splunkd group=tcpin_connections earliest=-1h \
    | stats latest(_time) as last_seen, sum(kb) as total_kb by hostname, dest_idx \
    | eval node_type="forwarder" \
    | eval health=case( \
        last_seen > relative_time(now(), "-15m"), "green", \
        last_seen > relative_time(now(), "-1h"), "yellow", \
        1=1, "red") \
    | eval node_id="uf_".hostname \
    | eval parent_id="idx_".dest_idx \
    | table node_id, hostname, node_type, health, parent_id, total_kb \
    | rename hostname as node_name \
] \
| search node_type=* \
| table node_id, node_name, node_type, health, parent_id, version, currentDBSizeMB, totalEventCount, total_kb
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# ============================================================================
# SCHEDULED TOPOLOGY DISCOVERY - Populates KV Store
# ============================================================================
# This search runs on a schedule (default: 2:03 AM daily) and discovers
# all topology components, then writes them to the KV Store for fast access.
# The search typically takes 5-15 minutes depending on environment size.
#

#
# Scheduled Search: Discover Nodes and Populate KV Store
# Discovers all forwarders, indexers, and search heads
#
[SA Topology - Scheduled Discovery - Nodes]
description = Discovers all infrastructure nodes and populates the topology KV Store
search = | makeresults count=1 \
    | eval discovery_time=now() \
    | fields discovery_time \
    | append [ \
        | rest /services/server/info splunk_server=local \
        | eval node_type=case( \
            match(server_roles, "shc_member"), "search_head_cluster", \
            match(server_roles, "search_head"), "search_head", \
            match(server_roles, "indexer"), "indexer", \
            1=1, "search_head") \
        | eval tier=if(node_type=="indexer", 1, 0) \
        | eval node_id=node_type."_".lower(replace(serverName, "[^a-zA-Z0-9]", "_")) \
        | eval health="green" \
        | eval role=case( \
            match(server_roles, "shc_captain"), "SHC Captain", \
            match(server_roles, "shc_member"), "SHC Member", \
            match(server_roles, "cluster_master"), "Cluster Master", \
            node_type=="search_head", "Standalone Search Head", \
            node_type=="indexer", "Standalone Indexer", \
            1=1, "Splunk Server") \
        | eval cluster=if(match(server_roles, "shc"), "shc1", "") \
        | table node_id, serverName, node_type, tier, health, role, cluster, version, os_name, cpu_arch \
        | rename serverName as hostname, os_name as os, cpu_arch as arch \
    ] \
    | append [ \
        | rest /services/shcluster/member/members splunk_server=local \
        | eval node_type="search_head_cluster", tier=0, health=if(status=="Up", "green", "yellow") \
        | eval node_id="search_head_cluster_".lower(replace(label, "[^a-zA-Z0-9]", "_")) \
        | eval role=if(is_captain=1, "SHC Captain", "SHC Member"), cluster="shc1" \
        | table node_id, label, node_type, tier, health, role, cluster \
        | rename label as hostname \
    ] \
    | append [ \
        | rest /services/search/distributed/peers \
        | eval node_type="indexer", tier=1, health=case(status=="Up", "green", status=="Down", "red", 1=1, "yellow") \
        | eval node_id="indexer_".lower(replace(peerName, "[^a-zA-Z0-9]", "_")) \
        | eval role=if(isnotnull(cluster_label), "Cluster Peer", "Peer Node") \
        | eval cluster=coalesce(cluster_label, "idxc1") \
        | table node_id, peerName, node_type, tier, health, role, cluster, version \
        | rename peerName as hostname \
    ] \
    | append [ \
        index=_internal sourcetype=splunkd group=tcpin_connections \
        | stats latest(fwdType) as fwd_type, latest(version) as version, \
                latest(arch) as arch, latest(os) as os, \
                latest(sourceIp) as source_ip, \
                sum(kb) as throughput_kb, avg(tcp_KBps) as avg_kbps, \
                latest(_time) as last_seen, \
                min(_time) as discovered_time \
            by hostname \
        | eval node_type=case( \
            fwd_type=="full" OR fwd_type=="heavy", "heavy_forwarder", \
            1=1, "universal_forwarder") \
        | eval tier=if(node_type=="heavy_forwarder", 2, 3) \
        | eval node_id=node_type."_".lower(replace(hostname, "[^a-zA-Z0-9]", "_")) \
        | eval health=case( \
            last_seen > relative_time(now(), "-15m"), "green", \
            last_seen > relative_time(now(), "-1h"), "yellow", \
            1=1, "red") \
        | eval role=case( \
            node_type=="heavy_forwarder", "Heavy Forwarder", \
            1=1, "Universal Forwarder") \
        | eval cluster="" \
        | table node_id, hostname, node_type, tier, health, role, cluster, version, os, arch, source_ip, throughput_kb, avg_kbps, last_seen, discovered_time \
    ] \
    | search node_id=* \
    | eval last_seen=coalesce(last_seen, now()), discovered_time=coalesce(discovered_time, now()) \
    | outputlookup sa_topology_nodes_lookup
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 3 2 * * *
enableSched = 1
schedule_window = auto
max_concurrent = 1
realtime_schedule = 0
action.email.useNSSubject = 1
alert.track = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Scheduled Search: Discover Connections and Populate KV Store
# Maps all data flow paths between nodes
#
[SA Topology - Scheduled Discovery - Connections]
description = Discovers all connections between nodes and populates the topology KV Store
search = index=_internal sourcetype=splunkd group=tcpin_connections \
    | stats sum(kb) as throughput_kb, latest(_time) as last_seen, \
            latest(fwdType) as fwd_type, values(splunk_server) as receivers \
        by hostname \
    | eval source_type=case( \
        fwd_type=="full" OR fwd_type=="heavy", "heavy_forwarder", \
        1=1, "universal_forwarder") \
    | eval source_node=source_type."_".lower(replace(hostname, "[^a-zA-Z0-9]", "_")) \
    | mvexpand receivers \
    | eval target_node="indexer_".lower(replace(receivers, "[^a-zA-Z0-9]", "_")) \
    | eval connection_id=source_node.":".target_node \
    | eval connection_type="data" \
    | stats sum(throughput_kb) as throughput_kb, latest(last_seen) as last_seen \
        by connection_id, source_node, target_node, connection_type \
    | append [ \
        | rest /services/search/distributed/peers \
        | eval source_node="search_head_".lower(replace(splunk_server, "[^a-zA-Z0-9]", "_")) \
        | eval target_node="indexer_".lower(replace(peerName, "[^a-zA-Z0-9]", "_")) \
        | eval connection_id=source_node.":".target_node \
        | eval connection_type="search", throughput_kb=0, last_seen=now() \
        | table connection_id, source_node, target_node, connection_type, throughput_kb, last_seen \
    ] \
    | append [ \
        index=_internal sourcetype=splunkd group=tcpin_connections fwdType=uf \
        | stats latest(splunk_server) as receiver by hostname \
        | join type=left receiver [ \
            search index=_internal sourcetype=splunkd group=tcpin_connections fwdType=full OR fwdType=heavy \
            | stats latest(splunk_server) as final_receiver by hostname \
            | rename hostname as receiver \
        ] \
        | where isnotnull(final_receiver) \
        | eval source_node="universal_forwarder_".lower(replace(hostname, "[^a-zA-Z0-9]", "_")) \
        | eval target_node="heavy_forwarder_".lower(replace(receiver, "[^a-zA-Z0-9]", "_")) \
        | eval connection_id=source_node.":".target_node \
        | eval connection_type="data", throughput_kb=0, last_seen=now() \
        | table connection_id, source_node, target_node, connection_type, throughput_kb, last_seen \
    ] \
    | dedup connection_id \
    | outputlookup sa_topology_connections_lookup
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 5 2 * * *
enableSched = 1
schedule_window = auto
max_concurrent = 1
realtime_schedule = 0
action.email.useNSSubject = 1
alert.track = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology
