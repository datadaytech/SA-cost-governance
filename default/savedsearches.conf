#
# Saved Searches for SA Topology Analyzer
# These searches discover infrastructure components from internal logs
#

#
# Universal Forwarder Discovery
# Finds all UFs that have sent data in the last 24 hours
#
[SA Topology - Universal Forwarders]
search = index=_internal sourcetype=splunkd group=tcpin_connections \
| stats latest(version) as version, \
        latest(arch) as architecture, \
        latest(os) as os, \
        sum(kb) as total_kb, \
        dc(sourceIp) as connection_count, \
        latest(_time) as last_seen \
        by hostname, guid \
| eval type="universal_forwarder" \
| eval last_seen_human=strftime(last_seen, "%Y-%m-%d %H:%M:%S") \
| eval health=case( \
    last_seen > relative_time(now(), "-15m"), "green", \
    last_seen > relative_time(now(), "-1h"), "yellow", \
    1=1, "red") \
| table hostname, guid, version, architecture, os, total_kb, connection_count, last_seen_human, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Alternative UF Discovery using metrics.log
# More reliable for some environments
#
[SA Topology - Universal Forwarders Alt]
search = index=_internal sourcetype=splunkd source=*metrics.log group=tcpin_connections \
| stats latest(version) as version, \
        latest(build) as build, \
        latest(fwdType) as forwarder_type, \
        sum(kb) as total_kb, \
        latest(_time) as last_seen \
        by hostname \
| where isnotnull(hostname) \
| eval type="universal_forwarder" \
| eval health=case( \
    last_seen > relative_time(now(), "-15m"), "green", \
    last_seen > relative_time(now(), "-1h"), "yellow", \
    1=1, "red") \
| table hostname, version, build, forwarder_type, total_kb, last_seen, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Index Discovery
# Finds all indexes and their data volumes
#
[SA Topology - Indexes]
search = | rest /services/data/indexes \
| search disabled=0 \
| eval size_gb=round(currentDBSizeMB/1024, 2) \
| eval type="index" \
| eval health=case( \
    currentDBSizeMB > 0 AND disabled=0, "green", \
    currentDBSizeMB = 0 AND disabled=0, "yellow", \
    1=1, "red") \
| table title, currentDBSizeMB, size_gb, totalEventCount, homePath, coldPath, maxDataSizeMB, health, type \
| rename title as index_name
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Index to Forwarder Mapping
# Shows which forwarders are sending data to which indexes
#
[SA Topology - Index Forwarder Mapping]
search = index=_internal sourcetype=splunkd group=tcpin_connections \
| stats dc(hostname) as forwarder_count, \
        values(hostname) as forwarders, \
        sum(kb) as total_kb \
        by dest_idx \
| rename dest_idx as index_name \
| eval type="index_mapping" \
| table index_name, forwarder_count, forwarders, total_kb, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Search Head Discovery
# Identifies search heads in the deployment
#
[SA Topology - Search Heads]
search = | rest /services/server/info \
| eval type="search_head" \
| eval is_shc_member=if(isnotnull(shcluster_label), "yes", "no") \
| eval health="green" \
| table serverName, version, build, os_name, cpu_arch, numberOfCores, physicalMemoryMB, is_shc_member, health, type
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Indexer Discovery
# Identifies indexers receiving data
#
[SA Topology - Indexers]
search = | rest /services/cluster/master/peers \
| eval type="indexer" \
| eval health=case( \
    status="Up", "green", \
    status="Detention", "yellow", \
    1=1, "red") \
| table label, site, status, replication_count, search_count, bucket_count, health, type \
| rename label as indexer_name
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology

#
# Full Topology Data - Combined view
# This is the main search for building the topology
#
[SA Topology - Full Topology]
search = | makeresults \
| eval search_type="topology_builder" \
| append [ \
    | rest /services/server/info \
    | eval node_type="search_head", health="green" \
    | eval node_id="sh_".serverName \
    | eval parent_id="root" \
    | table node_id, serverName, node_type, health, parent_id, version \
    | rename serverName as node_name \
] \
| append [ \
    | rest /services/data/indexes \
    | search disabled=0 totalEventCount>0 \
    | eval node_type="index", health=if(currentDBSizeMB>0, "green", "yellow") \
    | eval node_id="idx_".title \
    | head 1 \
    | eval parent_id="sh_".splunk_server \
    | table node_id, title, node_type, health, parent_id, currentDBSizeMB, totalEventCount \
    | rename title as node_name \
] \
| append [ \
    index=_internal sourcetype=splunkd group=tcpin_connections earliest=-1h \
    | stats latest(_time) as last_seen, sum(kb) as total_kb by hostname, dest_idx \
    | eval node_type="forwarder" \
    | eval health=case( \
        last_seen > relative_time(now(), "-15m"), "green", \
        last_seen > relative_time(now(), "-1h"), "yellow", \
        1=1, "red") \
    | eval node_id="uf_".hostname \
    | eval parent_id="idx_".dest_idx \
    | table node_id, hostname, node_type, health, parent_id, total_kb \
    | rename hostname as node_name \
] \
| search node_type=* \
| table node_id, node_name, node_type, health, parent_id, version, currentDBSizeMB, totalEventCount, total_kb
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
enableSched = 0
request.ui_dispatch_app = sa_topology_analyzer
request.ui_dispatch_view = topology
