<form version="1.1" theme="light">
  <label>SA Topology Analyzer</label>
  <description>Dynamic infrastructure topology visualization - Similar to ITSI Service Analyzer</description>

  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_range" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="view_mode" searchWhenChanged="true">
      <label>View Mode</label>
      <choice value="live">Live Data</choice>
      <choice value="mock">Mock Demo</choice>
      <default>mock</default>
    </input>
  </fieldset>

  <!-- Health Summary Row -->
  <row>
    <panel>
      <html>
        <style>
          .topology-header {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 10px;
          }
          .topology-header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #333;
          }
          .topology-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
          }
          .health-summary {
            display: flex;
            gap: 20px;
            margin-top: 15px;
          }
          .health-badge {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
          }
          .health-badge .count {
            font-size: 24px;
            margin-right: 10px;
            font-weight: 700;
          }
          .health-badge.green {
            background: rgba(101, 166, 55, 0.15);
            color: #65A637;
            border: 2px solid #65A637;
          }
          .health-badge.yellow {
            background: rgba(248, 190, 52, 0.15);
            color: #D9A400;
            border: 2px solid #F8BE34;
          }
          .health-badge.red {
            background: rgba(220, 78, 65, 0.15);
            color: #DC4E41;
            border: 2px solid #DC4E41;
          }
          #topology-container {
            width: 100%;
            min-height: 600px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            position: relative;
          }
          .node text {
            font-family: Arial, sans-serif;
            font-size: 11px;
          }
          .link {
            fill: none;
            stroke: #B5B5B5;
            stroke-width: 2px;
          }
          .legend text {
            font-size: 12px;
            fill: #333;
          }
          #node-details {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            min-width: 250px;
            display: none;
            z-index: 1000;
          }
          #node-details h3 {
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #65A637;
          }
          #node-details .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
          }
          #node-details .label { color: #666; }
          #node-details .value { font-weight: 600; }
        </style>

        <div class="topology-header">
          <h1>Splunk Infrastructure Topology</h1>
          <p>Real-time visualization of data flow from Universal Forwarders through Indexes to Search Heads</p>
          <div class="health-summary">
            <div class="health-badge green">
              <span class="count" id="health-green">0</span>
              <span>Healthy</span>
            </div>
            <div class="health-badge yellow">
              <span class="count" id="health-yellow">0</span>
              <span>Warning</span>
            </div>
            <div class="health-badge red">
              <span class="count" id="health-red">0</span>
              <span>Critical</span>
            </div>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- Main Topology Visualization -->
  <row>
    <panel>
      <html>
        <div id="topology-container"></div>
        <div id="node-details"></div>

        <script src="/static/app/sa-topology/d3.v7.min.js"></script>
        <script>
          (function() {
            // Wait for D3 to load
            var checkD3 = setInterval(function() {
              if (typeof d3 !== 'undefined') {
                clearInterval(checkD3);
                initTopology();
              }
            }, 100);

            function initTopology() {
              console.log('Initializing topology with D3 version:', d3.version);

              // Mock data
              var mockData = {
                id: 'root',
                name: 'Splunk Infrastructure',
                type: 'root',
                health: 'green',
                children: [
                  {
                    id: 'sh_1',
                    name: 'search-head-01',
                    type: 'search_head',
                    health: 'green',
                    children: [
                      {
                        id: 'idx_main',
                        name: 'main',
                        type: 'index',
                        health: 'green',
                        children: [
                          { id: 'uf_1', name: 'web-server-01', type: 'forwarder', health: 'green', children: [] },
                          { id: 'uf_2', name: 'web-server-02', type: 'forwarder', health: 'green', children: [] },
                          { id: 'uf_3', name: 'app-server-01', type: 'forwarder', health: 'yellow', children: [] }
                        ]
                      },
                      {
                        id: 'idx_internal',
                        name: '_internal',
                        type: 'index',
                        health: 'green',
                        children: [
                          { id: 'uf_4', name: 'firewall-01', type: 'forwarder', health: 'green', children: [] },
                          { id: 'uf_5', name: 'ids-sensor-01', type: 'forwarder', health: 'red', children: [] }
                        ]
                      },
                      {
                        id: 'idx_metrics',
                        name: '_metrics',
                        type: 'index',
                        health: 'yellow',
                        children: [
                          { id: 'uf_6', name: 'monitor-01', type: 'forwarder', health: 'green', children: [] }
                        ]
                      }
                    ]
                  },
                  {
                    id: 'sh_2',
                    name: 'search-head-02',
                    type: 'search_head',
                    health: 'green',
                    children: [
                      {
                        id: 'idx_audit',
                        name: '_audit',
                        type: 'index',
                        health: 'green',
                        children: [
                          { id: 'uf_7', name: 'dc-01', type: 'forwarder', health: 'green', children: [] },
                          { id: 'uf_8', name: 'dc-02', type: 'forwarder', health: 'green', children: [] }
                        ]
                      }
                    ]
                  }
                ]
              };

              // Colors
              var colors = {
                green: '#65A637',
                yellow: '#F8BE34',
                red: '#DC4E41',
                unknown: '#708794'
              };

              // Calculate health counts
              var healthCounts = { green: 0, yellow: 0, red: 0 };
              function countHealth(node) {
                if (node.health) healthCounts[node.health] = (healthCounts[node.health] || 0) + 1;
                if (node.children) node.children.forEach(countHealth);
              }
              countHealth(mockData);

              document.getElementById('health-green').textContent = healthCounts.green;
              document.getElementById('health-yellow').textContent = healthCounts.yellow;
              document.getElementById('health-red').textContent = healthCounts.red;

              // Setup SVG
              var container = document.getElementById('topology-container');
              var width = container.offsetWidth || 1000;
              var height = 600;

              var svg = d3.select('#topology-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

              var g = svg.append('g')
                .attr('transform', 'translate(50, 50)');

              // Create tree layout
              var treeLayout = d3.tree()
                .size([width - 100, height - 150]);

              var root = d3.hierarchy(mockData);
              treeLayout(root);

              // Draw links
              g.selectAll('.link')
                .data(root.links())
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('d', function(d) {
                  return 'M' + d.source.x + ',' + d.source.y +
                         'C' + d.source.x + ',' + (d.source.y + d.target.y) / 2 +
                         ' ' + d.target.x + ',' + (d.source.y + d.target.y) / 2 +
                         ' ' + d.target.x + ',' + d.target.y;
                });

              // Draw nodes
              var nodes = g.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                  showDetails(d.data);
                });

              // Node circles
              nodes.append('circle')
                .attr('r', 25)
                .attr('fill', function(d) { return colors[d.data.health] || colors.unknown; })
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .style('filter', 'drop-shadow(0px 2px 4px rgba(0,0,0,0.2))');

              // Node type labels
              nodes.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', 4)
                .attr('fill', '#fff')
                .attr('font-weight', 'bold')
                .attr('font-size', '12px')
                .text(function(d) {
                  var abbrev = { root: 'R', search_head: 'SH', index: 'IX', forwarder: 'UF' };
                  return abbrev[d.data.type] || '?';
                });

              // Node name labels
              nodes.append('text')
                .attr('text-anchor', 'middle')
                .attr('y', 40)
                .attr('fill', '#333')
                .attr('font-size', '10px')
                .text(function(d) {
                  var name = d.data.name;
                  return name.length > 15 ? name.substring(0, 13) + '...' : name;
                });

              // Add legend
              var legend = svg.append('g')
                .attr('class', 'legend')
                .attr('transform', 'translate(20, 20)');

              var legendData = [
                { label: 'Healthy', color: colors.green },
                { label: 'Warning', color: colors.yellow },
                { label: 'Critical', color: colors.red }
              ];

              legendData.forEach(function(item, i) {
                var lg = legend.append('g')
                  .attr('transform', 'translate(0, ' + (i * 25) + ')');
                lg.append('circle')
                  .attr('r', 8)
                  .attr('fill', item.color);
                lg.append('text')
                  .attr('x', 15)
                  .attr('y', 4)
                  .text(item.label);
              });

              // Show details function
              function showDetails(data) {
                var panel = document.getElementById('node-details');
                panel.innerHTML = '<h3>' + data.name + '</h3>' +
                  '<div class="detail-row"><span class="label">Type:</span><span class="value">' + data.type + '</span></div>' +
                  '<div class="detail-row"><span class="label">Health:</span><span class="value" style="color:' + colors[data.health] + '">' + data.health.toUpperCase() + '</span></div>' +
                  '<div class="detail-row"><span class="label">Children:</span><span class="value">' + (data.children ? data.children.length : 0) + '</span></div>';
                panel.style.display = 'block';
              }

              // Add zoom
              var zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', function(event) {
                  g.attr('transform', event.transform);
                });

              svg.call(zoom);

              console.log('Topology visualization complete');
            }
          })();
        </script>
      </html>
    </panel>
  </row>

</form>
