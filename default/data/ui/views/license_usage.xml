<dashboard version="1.1" theme="dark">
  <label>License Usage</label>
  <description>Detailed license usage analysis and trends</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_range">
      <label>Time Range</label>
      <default>
        <earliest>-7d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <title>License Usage Over Time</title>
      <chart>
        <search>
          <query>index=_internal sourcetype=splunkd component=LicenseUsage type=Usage
| timechart span=1d sum(b) as bytes
| eval GB=round(bytes/1024/1024/1024, 2)
| fields _time GB</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisTitleY.text">GB Ingested</option>
        <option name="charting.chart.showDataLabels">minmax</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Usage by Index</title>
      <table>
        <search>
          <query>index=_internal sourcetype=splunkd component=LicenseUsage type=Usage
| stats sum(b) as bytes by idx
| eval GB=round(bytes/1024/1024/1024, 2)
| sort -GB
| rename idx as "Index", GB as "GB Used"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <title>Usage by Sourcetype</title>
      <table>
        <search>
          <query>index=_internal sourcetype=splunkd component=LicenseUsage type=Usage
| stats sum(b) as bytes by st
| eval GB=round(bytes/1024/1024/1024, 2)
| sort -GB
| head 20
| rename st as "Sourcetype", GB as "GB Used"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Usage by Host</title>
      <table>
        <search>
          <query>index=_internal sourcetype=splunkd component=LicenseUsage type=Usage
| stats sum(b) as bytes by h
| eval GB=round(bytes/1024/1024/1024, 2)
| sort -GB
| head 20
| rename h as "Host", GB as "GB Used"</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <title>License Pool Status</title>
      <table>
        <search>
          <query>| rest /services/licenser/pools splunk_server=local
| eval used_GB=round(used_bytes/1024/1024/1024, 2)
| eval quota_GB=round(effective_quota/1024/1024/1024, 2)
| eval pct_used=round(used_bytes/effective_quota*100, 1)
| table title, quota_GB, used_GB, pct_used
| rename title as "Pool", quota_GB as "Quota (GB)", used_GB as "Used (GB)", pct_used as "% Used"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
</dashboard>
